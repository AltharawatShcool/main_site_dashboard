<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة إدارة مدرسة الثروات الوطنية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/firebase@9.15.0/firebase-app-compat.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/firebase@9.15.0/firebase-firestore-compat.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/firebase@9.15.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap');
        
        * {
            font-family: 'Tajawal', sans-serif;
        }
        
        .fade-in {
            animation: fadeIn 1s ease-in;
        }
        
        .slide-up {
            animation: slideUp 0.8s ease-out;
        }
        
        .bounce-in {
            animation: bounceIn 1.2s ease-out;
        }
        
        .slide-in-right {
            animation: slideInRight 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes bounceIn {
            0%, 20%, 40%, 60%, 80% {
                transform: translateY(0);
                animation-timing-function: cubic-bezier(0.215, 0.610, 0.355, 1.000);
            }
            0% { opacity: 0; transform: scale3d(.3, .3, .3); }
            20% { transform: scale3d(1.1, 1.1, 1.1); }
            40% { transform: scale3d(.9, .9, .9); }
            60% { opacity: 1; transform: scale3d(1.03, 1.03, 1.03); }
            80% { transform: scale3d(.97, .97, .97); }
            to { opacity: 1; transform: scale3d(1, 1, 1); }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .hero-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
        }
        
        .hover-scale {
            transition: transform 0.3s ease;
        }
        
        .hover-scale:hover {
            transform: scale(1.05);
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #5D5CDE;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .login-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .login-card {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .dashboard-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .dashboard-card:hover {
            border-left-color: #5D5CDE;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .tab-button.active {
            background-color: #5D5CDE;
            color: white;
        }
        
        .attendance-present {
            background-color: #10B981;
        }
        
        .attendance-absent {
            background-color: #EF4444;
        }
        
        .attendance-late {
            background-color: #F59E0B;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6B7280;
        }
        
        .success-message {
            background: linear-gradient(135deg, #10B981, #059669);
        }
        
        .error-message {
            background: linear-gradient(135deg, #EF4444, #DC2626);
        }
        
        .drag-drop-area {
            border: 2px dashed #D1D5DB;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .drag-drop-area:hover,
        .drag-drop-area.drag-over {
            border-color: #5D5CDE;
            background-color: #F3F4F6;
        }
        
        .student-card {
            transition: all 0.3s ease;
            border: 1px solid #E5E7EB;
        }
        
        .student-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .whatsapp-btn {
            background: linear-gradient(135deg, #25D366, #128C7E);
        }
        
        .whatsapp-btn:hover {
            background: linear-gradient(135deg, #128C7E, #075E54);
        }
        
        .admin-only {
            display: block;
        }
        
        .teacher-hidden {
            display: none !important;
        }

        .archived-plan {
            background-color: #f3f4f6;
            opacity: 0.7;
        }

        .search-highlight {
            background-color: yellow;
            padding: 1px 2px;
            border-radius: 2px;
        }

        .activity-card {
            transition: all 0.3s ease;
            border-left: 4px solid #5D5CDE;
        }

        .activity-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(93, 92, 222, 0.15);
        }

        .activity-status-active {
            background: linear-gradient(135deg, #10B981, #059669);
        }

        .activity-status-completed {
            background: linear-gradient(135deg, #6B7280, #4B5563);
        }

        .activity-status-upcoming {
            background: linear-gradient(135deg, #F59E0B, #D97706);
        }

        .section-badge {
            background: linear-gradient(135deg, #8B5CF6, #A855F7);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .report-card {
            transition: all 0.3s ease;
            border: 1px solid #E5E7EB;
            border-radius: 12px;
            padding: 1.5rem;
            background: white;
        }

        .report-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .grade-excellent {
            background: linear-gradient(135deg, #10B981, #059669);
        }

        .grade-good {
            background: linear-gradient(135deg, #3B82F6, #1D4ED8);
        }

        .grade-average {
            background: linear-gradient(135deg, #F59E0B, #D97706);
        }

        .grade-poor {
            background: linear-gradient(135deg, #EF4444, #DC2626);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#667eea'
                    }
                }
            }
        }
        
        // Dark mode support
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900">
    <!-- Login Screen -->
    <div id="login-screen" class="login-container flex items-center justify-center">
        <div class="login-card rounded-2xl p-8 w-full max-w-md mx-4 slide-up">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <i class="fas fa-graduation-cap text-primary text-3xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">لوحة الإدارة</h1>
                <p class="text-gray-600">مدرسة الثروات الوطنية الخاصة</p>
            </div>
            
            <form id="login-form">
                <div class="mb-6">
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-2">اسم المستخدم</label>
                    <input type="text" id="username" name="username" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-base"
                           placeholder="أدخل اسم المستخدم">
                </div>
                
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-2">كلمة المرور</label>
                    <input type="password" id="password" name="password" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-base"
                           placeholder="أدخل كلمة المرور">
                </div>
                
                <div id="login-error" class="hidden mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                    اسم المستخدم أو كلمة المرور غير صحيحة
                </div>
                
                <button type="submit" id="login-btn"
                        class="w-full bg-primary text-white py-3 rounded-lg font-semibold hover:bg-opacity-90 transition-colors">
                    <span id="login-text">تسجيل الدخول</span>
                    <div id="login-spinner" class="hidden loading-spinner mx-auto"></div>
                </button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-lg">
            <nav class="container mx-auto px-4 py-3">
                <div class="flex items-center justify-between">
                    <!-- Logo and School Name -->
                    <div class="flex items-center space-x-4 space-x-reverse">
                        <div class="w-12 h-12 bg-primary rounded-full flex items-center justify-center">
                            <i class="fas fa-graduation-cap text-white text-xl"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-primary">لوحة إدارة المدرسة</h1>
                            <p class="text-sm text-gray-600 dark:text-gray-400">مدرسة الثروات الوطنية الخاصة</p>
                        </div>
                    </div>
                    
                    <!-- User Menu -->
                    <div class="flex items-center space-x-4 space-x-reverse">
                        <div class="hidden md:block">
                            <span class="text-sm text-gray-600 dark:text-gray-400">مرحباً، </span>
                            <span id="user-name" class="font-semibold">المدير</span>
                            <span id="user-role-badge" class="mr-2 px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs"></span>
                            <span id="user-section-badge" class="hidden mr-2 section-badge text-xs"></span>
                        </div>
                        <button id="logout-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                            <i class="fas fa-sign-out-alt ml-2"></i>
                            تسجيل الخروج
                        </button>
                    </div>
                </div>
            </nav>
        </header>

        <!-- Hero Section -->
        <section class="hero-bg py-16 text-white">
            <div class="container mx-auto px-4 text-center">
                <div class="bounce-in">
                    <h2 class="text-4xl md:text-5xl font-bold mb-4">لوحة إدارة المدرسة</h2>
                    <p class="text-xl mb-6">إدارة شاملة لجميع أنشطة المدرسة</p>
                    <div class="grid grid-cols-1 md:grid-cols-6 gap-6 max-w-7xl mx-auto mt-8">
                        <div class="stats-card">
                            <i class="fas fa-calendar-week text-3xl mb-2"></i>
                            <div class="text-2xl font-bold" id="plans-count">0</div>
                            <div class="text-sm opacity-90">خطة أسبوعية</div>
                        </div>
                        <div class="stats-card">
                            <i class="fas fa-users text-3xl mb-2"></i>
                            <div class="text-2xl font-bold" id="students-count">0</div>
                            <div class="text-sm opacity-90">طالب وطالبة</div>
                        </div>
                        <div class="stats-card">
                            <i class="fas fa-chalkboard-teacher text-3xl mb-2"></i>
                            <div class="text-2xl font-bold" id="teachers-count">0</div>
                            <div class="text-sm opacity-90">معلم ومعلمة</div>
                        </div>
                        <div class="stats-card">
                            <i class="fas fa-calendar-day text-3xl mb-2"></i>
                            <div class="text-2xl font-bold" id="activities-count">0</div>
                            <div class="text-sm opacity-90">نشاط</div>
                        </div>
                        <div class="stats-card">
                            <i class="fas fa-chart-line text-3xl mb-2"></i>
                            <div class="text-2xl font-bold" id="attendance-rate">95%</div>
                            <div class="text-sm opacity-90">نسبة الحضور</div>
                        </div>
                        <div class="stats-card">
                            <i class="fas fa-file-alt text-3xl mb-2"></i>
                            <div class="text-2xl font-bold" id="reports-count">0</div>
                            <div class="text-sm opacity-90">تقرير أداء</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Dashboard Navigation -->
        <section class="py-8 bg-gray-50 dark:bg-gray-800">
            <div class="container mx-auto px-4">
                <div class="flex flex-wrap justify-center gap-4 mb-8">
                    <button class="tab-button active px-6 py-3 rounded-lg font-semibold transition-colors" data-tab="plans">
                        <i class="fas fa-calendar-week ml-2"></i>
                        الخطط الأسبوعية
                    </button>
                    <button class="tab-button px-6 py-3 rounded-lg font-semibold transition-colors bg-gray-200 dark:bg-gray-700" data-tab="students">
                        <i class="fas fa-user-graduate ml-2"></i>
                        إدارة الطلاب
                    </button>
                    <button class="tab-button px-6 py-3 rounded-lg font-semibold transition-colors bg-gray-200 dark:bg-gray-700" data-tab="attendance">
                        <i class="fas fa-user-check ml-2"></i>
                        الحضور والغياب
                    </button>
                    <button class="tab-button px-6 py-3 rounded-lg font-semibold transition-colors bg-gray-200 dark:bg-gray-700" data-tab="reports">
                        <i class="fas fa-chart-bar ml-2"></i>
                        تقارير الأداء
                    </button>
                    <button class="tab-button px-6 py-3 rounded-lg font-semibold transition-colors bg-gray-200 dark:bg-gray-700" data-tab="activities">
                        <i class="fas fa-calendar-day ml-2"></i>
                        إدارة الأنشطة
                    </button>
                    <button id="users-tab-btn" class="tab-button admin-only px-6 py-3 rounded-lg font-semibold transition-colors bg-gray-200 dark:bg-gray-700" data-tab="users">
                        <i class="fas fa-users-cog ml-2"></i>
                        إدارة المستخدمين
                    </button>
                </div>
            </div>
        </section>

        <!-- Weekly Plans Tab -->
        <section id="plans-tab" class="tab-content py-8">
            <div class="container mx-auto px-4">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                        <h3 class="text-2xl font-bold text-primary mb-4 md:mb-0">إدارة الخطط الأسبوعية</h3>
                        <button id="add-plan-btn" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-opacity-90 transition-colors">
                            <i class="fas fa-plus ml-2"></i>
                            إضافة خطة جديدة
                        </button>
                    </div>
                    
                    <!-- Advanced Search and Filter Section -->
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg mb-6">
                        <h4 class="text-lg font-semibold mb-4">البحث والتصفية المتقدم</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-4">
                            <div>
                                <label for="plans-grade-select" class="block text-sm font-medium mb-2">الصف:</label>
                                <select id="plans-grade-select" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base">
                                    <option value="">جميع الصفوف</option>
                                </select>
                            </div>
                            <div>
                                <label for="plans-section-select" class="block text-sm font-medium mb-2">الشعبة:</label>
                                <select id="plans-section-select" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base">
                                    <option value="">جميع الشعب</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                </select>
                            </div>
                            <div>
                                <label for="plans-subject-search" class="block text-sm font-medium mb-2">المادة:</label>
                                <input type="text" id="plans-subject-search" placeholder="البحث بالمادة" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base">
                            </div>
                            <div>
                                <label for="plans-topic-search" class="block text-sm font-medium mb-2">الموضوع:</label>
                                <input type="text" id="plans-topic-search" placeholder="البحث بالموضوع" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base">
                            </div>
                            <div>
                                <label for="plans-teacher-search" class="block text-sm font-medium mb-2">المعلم:</label>
                                <input type="text" id="plans-teacher-search" placeholder="البحث بالمعلم" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label for="plans-date-from" class="block text-sm font-medium mb-2">من تاريخ:</label>
                                <input type="date" id="plans-date-from" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base">
                            </div>
                            <div>
                                <label for="plans-date-to" class="block text-sm font-medium mb-2">إلى تاريخ:</label>
                                <input type="date" id="plans-date-to" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base">
                            </div>
                            <div>
                                <label for="plans-status-filter" class="block text-sm font-medium mb-2">الحالة:</label>
                                <select id="plans-status-filter" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base">
                                    <option value="">جميع الخطط</option>
                                    <option value="active">الخطط النشطة</option>
                                    <option value="archived">الخطط المؤرشفة</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button id="search-plans-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                                <i class="fas fa-search ml-2"></i>
                                بحث
                            </button>
                            <button id="clear-search-btn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                                <i class="fas fa-times ml-2"></i>
                                مسح الفلاتر
                            </button>
                            <button id="export-plans-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                                <i class="fas fa-file-excel ml-2"></i>
                                تصدير النتائج
                            </button>
                        </div>
                    </div>
                    
                    <div id="plans-loading" class="text-center py-8">
                        <div class="loading-spinner mx-auto mb-4"></div>
                        <p>جاري تحميل الخطط الأسبوعية...</p>
                    </div>
                    
                    <div id="plans-table-container" class="hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse border border-gray-300 dark:border-gray-600">
                                <thead>
                                    <tr class="bg-primary text-white">
                                        <th class="border border-gray-300 px-4 py-2">الصف</th>
                                        <th class="border border-gray-300 px-4 py-2">الشعبة</th>
                                        <th class="border border-gray-300 px-4 py-2">التاريخ</th>
                                        <th class="border border-gray-300 px-4 py-2">اليوم</th>
                                        <th class="border border-gray-300 px-4 py-2">المادة</th>
                                        <th class="border border-gray-300 px-4 py-2">الموضوع</th>
                                        <th class="border border-gray-300 px-4 py-2">الأنشطة</th>
                                        <th class="border border-gray-300 px-4 py-2">المعلم</th>
                                        <th class="border border-gray-300 px-4 py-2">الحالة</th>
                                        <th class="border border-gray-300 px-4 py-2">إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="plans-table-body">
                                    <!-- Plans will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="plans-empty" class="hidden empty-state">
                        <i class="fas fa-calendar-plus text-6xl mb-4"></i>
                        <h4 class="text-xl font-semibold mb-2">لا توجد خطط أسبوعية</h4>
                        <p class="mb-4">ابدأ بإضافة الخطط الأسبوعية للصفوف</p>
                        <button onclick="document.getElementById('add-plan-btn').click()" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-opacity-90 transition-colors">
                            إضافة خطة جديدة
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Students Management Tab -->
        <section id="students-tab" class="tab-content hidden py-8">
            <div class="container mx-auto px-4">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                        <h3 class="text-2xl font-bold text-primary mb-4 md:mb-0">إدارة الطلاب</h3>
                        <div class="flex flex-wrap gap-2">
                            <button id="add-student-btn" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-opacity-90 transition-colors">
                                <i class="fas fa-user-plus ml-2"></i>
                                إضافة طالب
                            </button>
                            <button id="import-students-btn" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition-colors">
                                <i class="fas fa-file-excel ml-2"></i>
                                استيراد Excel
                            </button>
                            <button id="export-students-btn" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                                <i class="fas fa-download ml-2"></i>
                                تصدير البيانات
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="students-grade-select" class="block text-sm font-medium mb-2">اختر الصف:</label>
                            <select id="students-grade-select" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base">
                                <option value="">جميع الصفوف</option>
                            </select>
                        </div>
                        <div>
                            <label for="students-section-select" class="block text-sm font-medium mb-2">اختر الشعبة:</label>
                            <select id="students-section-select" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base">
                                <option value="">جميع الشعب</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="students-loading" class="text-center py-8">
                        <div class="loading-spinner mx-auto mb-4"></div>
                        <p>جاري تحميل بيانات الطلاب...</p>
                    </div>
                    
                    <div id="students-grid" class="hidden grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Students will be loaded here -->
                    </div>
                    
                    <div id="students-empty" class="hidden empty-state">
                        <i class="fas fa-users text-6xl mb-4"></i>
                        <h4 class="text-xl font-semibold mb-2">لا يوجد طلاب</h4>
                        <p class="mb-4">ابدأ بإضافة الطلاب للصفوف الدراسية</p>
                        <button onclick="document.getElementById('add-student-btn').click()" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-opacity-90 transition-colors">
                            إضافة طالب جديد
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Attendance Tab -->
        <section id="attendance-tab" class="tab-content hidden py-8">
            <div class="container mx-auto px-4">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                        <h3 class="text-2xl font-bold text-primary mb-4 md:mb-0">إدارة الحضور والغياب</h3>
                        <button id="send-whatsapp-btn" class="whatsapp-btn text-white px-6 py-2 rounded-lg hover:bg-opacity-90 transition-colors">
                            <i class="fab fa-whatsapp ml-2"></i>
                            إرسال تقرير للأولياء
                        </button>
                    </div>
                    
                    <div class="grid md:grid-cols-3 gap-6 mb-6">
                        <div>
                            <label for="attendance-grade-select" class="block text-sm font-medium mb-2">اختر الصف:</label>
                            <select id="attendance-grade-select" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base">
                                <option value="">اختر الصف</option>
                            </select>
                        </div>
                        <div>
                            <label for="attendance-section-select" class="block text-sm font-medium mb-2">اختر الشعبة:</label>
                            <select id="attendance-section-select" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base">
                                <option value="">اختر الشعبة</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                            </select>
                        </div>
                        <div>
                            <label for="attendance-date" class="block text-sm font-medium mb-2">التاريخ:</label>
                            <input type="date" id="attendance-date" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base">
                        </div>
                    </div>
                    
                    <div id="attendance-container" class="hidden">
                        <div class="mb-4 flex flex-wrap gap-4">
                            <div class="flex items-center space-x-2 space-x-reverse">
                                <div class="w-4 h-4 attendance-present rounded"></div>
                                <span class="text-sm">حاضر</span>
                            </div>
                            <div class="flex items-center space-x-2 space-x-reverse">
                                <div class="w-4 h-4 attendance-absent rounded"></div>
                                <span class="text-sm">غائب</span>
                            </div>
                            <div class="flex items-center space-x-2 space-x-reverse">
                                <div class="w-4 h-4 attendance-late rounded"></div>
                                <span class="text-sm">متأخر</span>
                            </div>
                        </div>
                        
                        <div id="attendance-loading" class="text-center py-8">
                            <div class="loading-spinner mx-auto mb-4"></div>
                            <p>جاري تحميل قائمة الطلاب...</p>
                        </div>
                        
                        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4" id="students-attendance">
                            <!-- Students will be loaded here -->
                        </div>
                        
                        <div class="mt-6 text-center">
                            <button id="save-attendance-btn" class="bg-primary text-white px-8 py-3 rounded-lg hover:bg-opacity-90 transition-colors">
                                <i class="fas fa-save ml-2"></i>
                                حفظ الحضور
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Reports Tab -->
        <section id="reports-tab" class="tab-content hidden py-8">
            <div class="container mx-auto px-4">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                        <h3 class="text-2xl font-bold text-primary mb-4 md:mb-0">تقارير أداء الطلاب</h3>
                        <button id="add-report-btn" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-opacity-90 transition-colors">
                            <i class="fas fa-plus ml-2"></i>
                            إضافة تقرير جديد
                        </button>
                    </div>
                    
                    <!-- Report Type Selection -->
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg mb-6">
                        <h4 class="text-lg font-semibold mb-4">نوع التقرير</h4>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label for="report-grade-select" class="block text-sm font-medium mb-2">الصف:</label>
                                <select id="report-grade-select" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base">
                                    <option value="">اختر الصف</option>
                                </select>
                            </div>
                            <div>
                                <label for="report-section-select" class="block text-sm font-medium mb-2">الشعبة:</label>
                                <select id="report-section-select" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base">
                                    <option value="">اختر الشعبة</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                </select>
                            </div>
                            <div>
                                <label for="report-period-select" class="block text-sm font-medium mb-2">فترة التقرير:</label>
                                <select id="report-period-select" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base">
                                    <option value="">اختر الفترة</option>
                                    <option value="weekly">أسبوعي</option>
                                    <option value="monthly">شهري</option>
                                    <option value="yearly">سنوي</option>
                                </select>
                            </div>
                            <div>
                                <button id="generate-report-btn" class="mt-7 w-full bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                                    <i class="fas fa-chart-bar ml-2"></i>
                                    إنشاء التقرير
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="reports-loading" class="text-center py-8 hidden">
                        <div class="loading-spinner mx-auto mb-4"></div>
                        <p>جاري إنشاء التقرير...</p>
                    </div>
                    
                    <div id="reports-container" class="hidden">
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="text-xl font-semibold">نتائج التقرير</h4>
                                <div class="flex gap-2">
                                    <button id="send-reports-whatsapp" class="whatsapp-btn text-white px-4 py-2 rounded-lg hover:bg-opacity-90 transition-colors">
                                        <i class="fab fa-whatsapp ml-2"></i>
                                        إرسال عبر الواتساب
                                    </button>
                                    <button id="export-reports-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                                        <i class="fas fa-file-excel ml-2"></i>
                                        تصدير Excel
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="reports-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Reports will be loaded here -->
                        </div>
                    </div>
                    
                    <div id="reports-empty" class="empty-state">
                        <i class="fas fa-chart-bar text-6xl mb-4"></i>
                        <h4 class="text-xl font-semibold mb-2">لا توجد تقارير</h4>
                        <p class="mb-4">اختر الصف والشعبة وفترة التقرير لإنشاء تقرير أداء الطلاب</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Activities Management Tab -->
        <section id="activities-tab" class="tab-content hidden py-8">
            <div class="container mx-auto px-4">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                        <h3 class="text-2xl font-bold text-primary mb-4 md:mb-0">إدارة الأنشطة المدرسية</h3>
                        <button id="add-activity-btn" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-opacity-90 transition-colors">
                            <i class="fas fa-plus ml-2"></i>
                            إضافة نشاط جديد
                        </button>
                    </div>
                    
                    <!-- Activity Filters -->
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg mb-6">
                        <h4 class="text-lg font-semibold mb-4">البحث والتصفية</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label for="activities-search" class="block text-sm font-medium mb-2">البحث في الأنشطة:</label>
                                <input type="text" id="activities-search" placeholder="البحث بالاسم أو الوصف" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base">
                            </div>
                            <div>
                                <label for="activities-date-filter" class="block text-sm font-medium mb-2">التاريخ:</label>
                                <input type="date" id="activities-date-filter" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base">
                            </div>
                            <div>
                                <label for="activities-status-filter" class="block text-sm font-medium mb-2">الحالة:</label>
                                <select id="activities-status-filter" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base">
                                    <option value="">جميع الأنشطة</option>
                                    <option value="upcoming">قادم</option>
                                    <option value="active">جاري</option>
                                    <option value="completed">مكتمل</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button id="search-activities-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                                <i class="fas fa-search ml-2"></i>
                                بحث
                            </button>
                            <button id="clear-activities-search-btn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                                <i class="fas fa-times ml-2"></i>
                                مسح الفلاتر
                            </button>
                            <button id="export-activities-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                                <i class="fas fa-file-excel ml-2"></i>
                                تصدير الأنشطة
                            </button>
                        </div>
                    </div>
                    
                    <div id="activities-loading" class="text-center py-8">
                        <div class="loading-spinner mx-auto mb-4"></div>
                        <p>جاري تحميل الأنشطة...</p>
                    </div>
                    
                    <div id="activities-grid" class="hidden grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Activities will be loaded here -->
                    </div>
                    
                    <div id="activities-empty" class="hidden empty-state">
                        <i class="fas fa-calendar-day text-6xl mb-4"></i>
                        <h4 class="text-xl font-semibold mb-2">لا توجد أنشطة</h4>
                        <p class="mb-4">ابدأ بإضافة الأنشطة المدرسية</p>
                        <button onclick="document.getElementById('add-activity-btn').click()" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-opacity-90 transition-colors">
                            إضافة نشاط جديد
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Users Management Tab -->
        <section id="users-tab" class="tab-content admin-only hidden py-8">
            <div class="container mx-auto px-4">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                        <h3 class="text-2xl font-bold text-primary mb-4 md:mb-0">إدارة المستخدمين</h3>
                        <button id="add-user-btn" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-opacity-90 transition-colors">
                            <i class="fas fa-user-plus ml-2"></i>
                            إضافة مستخدم جديد
                        </button>
                    </div>
                    
                    <div id="users-loading" class="text-center py-8">
                        <div class="loading-spinner mx-auto mb-4"></div>
                        <p>جاري تحميل المستخدمين...</p>
                    </div>
                    
                    <div id="users-table-container" class="hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse border border-gray-300 dark:border-gray-600">
                                <thead>
                                    <tr class="bg-primary text-white">
                                        <th class="border border-gray-300 px-4 py-2">الاسم</th>
                                        <th class="border border-gray-300 px-4 py-2">اسم المستخدم</th>
                                        <th class="border border-gray-300 px-4 py-2">الدور</th>
                                        <th class="border border-gray-300 px-4 py-2">الصلاحيات</th>
                                        <th class="border border-gray-300 px-4 py-2">الحالة</th>
                                        <th class="border border-gray-300 px-4 py-2">إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body">
                                    <!-- Users will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="users-empty" class="hidden empty-state">
                        <i class="fas fa-users text-6xl mb-4"></i>
                        <h4 class="text-xl font-semibold mb-2">لا يوجد مستخدمون</h4>
                        <p class="mb-4">ابدأ بإضافة المعلمين والمستخدمين</p>
                        <button onclick="document.getElementById('add-user-btn').click()" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-opacity-90 transition-colors">
                            إضافة مستخدم جديد
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="bg-gray-900 text-white py-12 mt-12">
            <div class="container mx-auto px-4">
                <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
                    <div>
                        <h5 class="text-lg font-semibold mb-4">المواقع المهمة</h5>
                        <ul class="space-y-2">
                            <li><a href="https://adek.gov.ae" target="_blank" class="hover:text-primary transition-colors">دائرة التعليم والمعرفة</a></li>
                            <li><a href="https://tam.adek.gov.ae" target="_blank" class="hover:text-primary transition-colors">موقع تم</a></li>
                            <li><a href="https://adek.gov.ae" target="_blank" class="hover:text-primary transition-colors">ADEK</a></li>
                        </ul>
                    </div>
                    
                    <div>
                        <h5 class="text-lg font-semibold mb-4">الإدارة</h5>
                        <ul class="space-y-2">
                            <li><a href="#" onclick="switchTab('plans')" class="hover:text-primary transition-colors">الخطط الأسبوعية</a></li>
                            <li><a href="#" onclick="switchTab('students')" class="hover:text-primary transition-colors">إدارة الطلاب</a></li>
                            <li><a href="#" onclick="switchTab('reports')" class="hover:text-primary transition-colors">تقارير الأداء</a></li>
                            <li><a href="#" onclick="switchTab('activities')" class="hover:text-primary transition-colors">إدارة الأنشطة</a></li>
                            <li><a href="#" onclick="switchTab('attendance')" class="hover:text-primary transition-colors">الحضور والغياب</a></li>
                            <li id="footer-users-link" class="admin-only"><a href="#" onclick="switchTab('users')" class="hover:text-primary transition-colors">إدارة المستخدمين</a></li>
                        </ul>
                    </div>
                    
                    <div>
                        <h5 class="text-lg font-semibold mb-4">معلومات الاتصال</h5>
                        <ul class="space-y-2">
                            <li>+971 5438357551</li>
                            <li>shcoolsschool2019@gmail.com</li>
                            <li>بني ياس شرق 9 -ابوظبي، الإمارات</li>
                        </ul>
                    </div>
                    
                    <div>
                        <h5 class="text-lg font-semibold mb-4">ساعات العمل</h5>
                        <ul class="space-y-2">
                            <li>الاتنين - الجمعه</li>
                            <li>7:30 ص - 2:30 م</li>
                            <li> الاحد: إجازة</li>
                        </ul>
                    </div>
                </div>
                
                <div class="border-t border-gray-700 mt-8 pt-8 text-center">
                    <p class="mb-4">جميع الحقوق محفوظة © 2025 مدرسة الثروات الوطنية الخاصة</p>
                    <p class="text-sm text-gray-400">تم التصميم من قبل المهندس حسين نقد</p>
                </div>
            </div>
        </footer>
    </div>

    <!-- Add Plan Modal -->
    <div id="add-plan-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 id="plan-modal-title" class="text-2xl font-bold text-primary">إضافة خطة أسبوعية</h3>
                <button id="close-plan-modal" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <form id="plan-form" class="space-y-4">
                <div class="grid md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">الصف</label>
                        <select id="plan-grade" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base">
                            <option value="">اختر الصف</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">الشعبة</label>
                        <select id="plan-section" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base">
                            <option value="">اختر الشعبة</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">التاريخ</label>
                        <input type="date" id="plan-date" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">اليوم</label>
                    <select id="plan-day" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base">
                        <option value="">اختر اليوم</option>
                        <option value="الاتنين">الاتنين</option>
                        <option value="الثلاثاء">الثلاثاء</option>
                        <option value="الاربعاء">الاربعاء</option>
                        <option value="الخميس">الخميس</option>
                        <option value="الجمعة">الجمعة</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">المادة</label>
                    <input type="text" id="plan-subject" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base" placeholder="اسم المادة">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">الموضوع</label>
                    <input type="text" id="plan-topic" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base" placeholder="موضوع الدرس">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">الأنشطة</label>
                    <textarea id="plan-activities" required rows="3" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base" placeholder="وصف الأنشطة المخططة"></textarea>
                </div>
                
                <div class="flex justify-end space-x-4 space-x-reverse">
                    <button type="button" id="cancel-plan" class="px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">إلغاء</button>
                    <button type="submit" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-colors">
                        <span id="plan-submit-text">حفظ الخطة</span>
                        <div id="plan-submit-spinner" class="hidden loading-spinner mx-auto"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div id="add-student-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-primary">إضافة طالب جديد</h3>
                <button id="close-student-modal" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <form id="student-form" class="space-y-4">
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">رقم الأساس <span class="text-red-500">*</span></label>
                        <input type="text" id="student-id" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base" placeholder="رقم الأساس">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">اسم الطالب <span class="text-red-500">*</span></label>
                        <input type="text" id="student-name" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base" placeholder="الاسم الكامل">
                    </div>
                </div>
                
                <div class="grid md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">الصف <span class="text-red-500">*</span></label>
                        <select id="student-grade" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base">
                            <option value="">اختر الصف</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">الشعبة <span class="text-red-500">*</span></label>
                        <select id="student-section" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base">
                            <option value="">اختر الشعبة</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">رقم ولي الأمر <span class="text-red-500">*</span></label>
                        <input type="tel" id="parent-phone" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base" placeholder="971501234567" dir="ltr">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">اسم ولي الأمر</label>
                    <input type="text" id="parent-name" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base" placeholder="اسم ولي الأمر">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">ملاحظات</label>
                    <textarea id="student-notes" rows="3" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base" placeholder="ملاحظات إضافية (اختياري)"></textarea>
                </div>
                
                <div class="flex justify-end space-x-4 space-x-reverse">
                    <button type="button" id="cancel-student" class="px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">إلغاء</button>
                    <button type="submit" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-colors">
                        <span id="student-submit-text">إضافة الطالب</span>
                        <div id="student-submit-spinner" class="hidden loading-spinner mx-auto"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Report Modal -->
    <div id="add-report-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-primary">إضافة تقرير أداء طالب</h3>
                <button id="close-report-modal" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <form id="report-form" class="space-y-6">
                <div class="grid md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">الطالب <span class="text-red-500">*</span></label>
                        <select id="report-student" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base">
                            <option value="">اختر الطالب</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">المادة <span class="text-red-500">*</span></label>
                        <input type="text" id="report-subject" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base" placeholder="اسم المادة">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">الدرجة <span class="text-red-500">*</span></label>
                        <input type="number" id="report-grade" required min="0" max="100" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base" placeholder="الدرجة من 100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">التاريخ <span class="text-red-500">*</span></label>
                        <input type="date" id="report-date" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base">
                    </div>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">نقاط القوة</label>
                        <textarea id="report-strengths" rows="4" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base" placeholder="اذكر نقاط القوة لدى الطالب"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">نقاط التحسين</label>
                        <textarea id="report-improvements" rows="4" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base" placeholder="اذكر النقاط التي تحتاج إلى تحسين"></textarea>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">ملاحظات المعلم</label>
                    <textarea id="report-notes" rows="3" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base" placeholder="ملاحظات إضافية من المعلم"></textarea>
                </div>
                
                <div class="flex justify-end space-x-4 space-x-reverse">
                    <button type="button" id="cancel-report" class="px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">إلغاء</button>
                    <button type="submit" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-colors">
                        <span id="report-submit-text">حفظ التقرير</span>
                        <div id="report-submit-spinner" class="hidden loading-spinner mx-auto"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Activity Modal -->
    <div id="add-activity-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 id="activity-modal-title" class="text-2xl font-bold text-primary">إضافة نشاط جديد</h3>
                <button id="close-activity-modal" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <form id="activity-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">اسم النشاط <span class="text-red-500">*</span></label>
                    <input type="text" id="activity-name" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base" placeholder="اسم النشاط">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">وصف النشاط <span class="text-red-500">*</span></label>
                    <textarea id="activity-description" required rows="4" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base" placeholder="وصف مفصل للنشاط"></textarea>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">تاريخ النشاط <span class="text-red-500">*</span></label>
                        <input type="date" id="activity-date" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">وقت النشاط <span class="text-red-500">*</span></label>
                        <input type="time" id="activity-time" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base">
                    </div>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">موقع النشاط</label>
                        <input type="text" id="activity-location" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base" placeholder="مكان إقامة النشاط">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">الفئة المستهدفة</label>
                        <select id="activity-target" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base">
                            <option value="all">جميع الصفوف</option>
                            <option value="primary">المرحلة الابتدائية</option>
                            <option value="middle">المرحلة المتوسطة</option>
                            <option value="high">المرحلة الثانوية</option>
                            <option value="specific">صفوف محددة</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">ملاحظات إضافية</label>
                    <textarea id="activity-notes" rows="3" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base" placeholder="ملاحظات أو تعليمات خاصة بالنشاط"></textarea>
                </div>
                
                <div class="flex justify-end space-x-4 space-x-reverse">
                    <button type="button" id="cancel-activity" class="px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">إلغاء</button>
                    <button type="submit" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-colors">
                        <span id="activity-submit-text">إضافة النشاط</span>
                        <div id="activity-submit-spinner" class="hidden loading-spinner mx-auto"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="add-user-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 id="user-modal-title" class="text-2xl font-bold text-primary">إضافة مستخدم جديد</h3>
                <button id="close-user-modal" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <form id="user-form" class="space-y-4">
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">الاسم الكامل <span class="text-red-500">*</span></label>
                        <input type="text" id="modal-user-name" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base" placeholder="الاسم الكامل">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">اسم المستخدم <span class="text-red-500">*</span></label>
                        <input type="text" id="modal-user-username" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base" placeholder="اسم المستخدم">
                    </div>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">كلمة المرور <span class="text-red-500">*</span></label>
                        <input type="password" id="modal-user-password" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base" placeholder="كلمة المرور">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">الدور <span class="text-red-500">*</span></label>
                        <select id="modal-user-role" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-base">
                            <option value="">اختر الدور</option>
                            <option value="teacher">معلم</option>
                            <option value="admin">مدير</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">الصلاحيات (الصفوف والشعب المسموح بإدارتها)</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div id="grade-permissions" class="space-y-2">
                            <!-- Grade checkboxes will be populated here -->
                        </div>
                        <div id="section-permissions" class="space-y-2">
                            <h5 class="font-medium text-sm">الشعب المسموحة:</h5>
                            <div class="space-y-1">
                                <label class="flex items-center space-x-2 space-x-reverse">
                                    <input type="checkbox" value="1" class="section-permissions">
                                    <span class="text-sm">الشعبة 1</span>
                                </label>
                                <label class="flex items-center space-x-2 space-x-reverse">
                                    <input type="checkbox" value="2" class="section-permissions">
                                    <span class="text-sm">الشعبة 2</span>
                                </label>
                                <label class="flex items-center space-x-2 space-x-reverse">
                                    <input type="checkbox" value="3" class="section-permissions">
                                    <span class="text-sm">الشعبة 3</span>
                                </label>
                                <label class="flex items-center space-x-2 space-x-reverse">
                                    <input type="checkbox" value="4" class="section-permissions">
                                    <span class="text-sm">الشعبة 4</span>
                                </label>
                                <label class="flex items-center space-x-2 space-x-reverse">
                                    <input type="checkbox" value="5" class="section-permissions">
                                    <span class="text-sm">الشعبة 5</span>
                                </label>
                                <label class="flex items-center space-x-2 space-x-reverse">
                                    <input type="checkbox" value="6" class="section-permissions">
                                    <span class="text-sm">الشعبة 6</span>
                                </label>
                                <label class="flex items-center space-x-2 space-x-reverse">
                                    <input type="checkbox" value="7" class="section-permissions">
                                    <span class="text-sm">الشعبة 7</span>
                                </label>
                                <label class="flex items-center space-x-2 space-x-reverse">
                                    <input type="checkbox" value="8" class="section-permissions">
                                    <span class="text-sm">الشعبة 8</span>
                                </label>
                                <label class="flex items-center space-x-2 space-x-reverse">
                                    <input type="checkbox" value="9" class="section-permissions">
                                    <span class="text-sm">الشعبة 9</span>
                                </label>
                                <label class="flex items-center space-x-2 space-x-reverse">
                                    <input type="checkbox" value="10" class="section-permissions">
                                    <span class="text-sm">الشعبة 10</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-4 space-x-reverse">
                    <button type="button" id="cancel-user" class="px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">إلغاء</button>
                    <button type="submit" id="user-submit-btn" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-colors">
                        <span id="user-submit-text">إضافة المستخدم</span>
                        <div id="user-submit-spinner" class="hidden loading-spinner mx-auto"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC1aGBA8OapqeNy-5mi1bOzcDGEgP-Xsr0",
            authDomain: "thawarat-project.firebaseapp.com",
            databaseURL: "https://thawarat-project-default-rtdb.firebaseio.com",
            projectId: "thawarat-project",
            storageBucket: "thawarat-project.firebasestorage.app",
            messagingSenderId: "847469725368",
            appId: "1:847469725368:web:550889ff05499c30f5564d",
            measurementId: "G-0G7JW998ES"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global variables
        let currentUser = null;
        let allPlans = [];
        let allUsers = [];
        let allStudents = [];
        let allActivities = [];
        let allReports = [];
        let currentExcelData = [];
        let currentSearchFilters = {};
        let currentActivityFilters = {};

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            setupEventListeners();
            setDefaultDates();
        }

        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendance-date').value = today;
            document.getElementById('plan-date').value = today;
            document.getElementById('activity-date').value = today;
            document.getElementById('report-date').value = today;
        }

        function setupEventListeners() {
            // Login functionality
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            
            // Logout functionality
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            
            // Tab functionality
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', handleTabClick);
            });
            
            // Plans functionality
            document.getElementById('add-plan-btn').addEventListener('click', openPlanModal);
            document.getElementById('close-plan-modal').addEventListener('click', closePlanModal);
            document.getElementById('cancel-plan').addEventListener('click', closePlanModal);
            document.getElementById('plan-form').addEventListener('submit', handlePlanSubmit);
            
            // Students functionality
            document.getElementById('add-student-btn').addEventListener('click', openStudentModal);
            document.getElementById('close-student-modal').addEventListener('click', closeStudentModal);
            document.getElementById('cancel-student').addEventListener('click', closeStudentModal);
            document.getElementById('student-form').addEventListener('submit', handleStudentSubmit);
            document.getElementById('students-grade-select').addEventListener('change', filterStudents);
            document.getElementById('students-section-select').addEventListener('change', filterStudents);
            
            // Reports functionality
            document.getElementById('add-report-btn').addEventListener('click', openReportModal);
            document.getElementById('close-report-modal').addEventListener('click', closeReportModal);
            document.getElementById('cancel-report').addEventListener('click', closeReportModal);
            document.getElementById('report-form').addEventListener('submit', handleReportSubmit);
            document.getElementById('generate-report-btn').addEventListener('click', generateReport);
            document.getElementById('send-reports-whatsapp').addEventListener('click', sendReportsViaWhatsApp);
            
            // Activities functionality
            document.getElementById('add-activity-btn').addEventListener('click', openActivityModal);
            document.getElementById('close-activity-modal').addEventListener('click', closeActivityModal);
            document.getElementById('cancel-activity').addEventListener('click', closeActivityModal);
            document.getElementById('activity-form').addEventListener('submit', handleActivitySubmit);
            
            // Users functionality
            document.getElementById('add-user-btn').addEventListener('click', openUserModal);
            document.getElementById('close-user-modal').addEventListener('click', closeUserModal);
            document.getElementById('cancel-user').addEventListener('click', closeUserModal);
            document.getElementById('user-form').addEventListener('submit', handleUserSubmit);
            
            // Attendance functionality
            document.getElementById('attendance-grade-select').addEventListener('change', handleAttendanceGradeSelect);
            document.getElementById('attendance-section-select').addEventListener('change', handleAttendanceGradeSelect);
            document.getElementById('save-attendance-btn').addEventListener('click', saveAttendance);
            
            // Search functionality for plans
            const searchInputs = ['plans-grade-select', 'plans-section-select', 'plans-subject-search', 'plans-topic-search', 'plans-teacher-search', 'plans-date-from', 'plans-date-to', 'plans-status-filter'];
            searchInputs.forEach(id => {
                document.getElementById(id).addEventListener('input', debounce(searchPlans, 300));
            });
            
            // Activity search functionality
            const activitySearchInputs = ['activities-search', 'activities-date-filter', 'activities-status-filter'];
            activitySearchInputs.forEach(id => {
                document.getElementById(id).addEventListener('input', debounce(searchActivities, 300));
            });
        }

        // Enhanced permission system for sections - updated for 10 sections
        function hasPermissionForGradeAndSection(grade, section) {
            if (!currentUser) return false;
            if (currentUser.role === 'admin') return true;
            if (currentUser.role === 'teacher') {
                const hasGradePermission = currentUser.permissions && (
                    currentUser.permissions.includes('all') || 
                    currentUser.permissions.includes(grade)
                );
                const hasSectionPermission = currentUser.sectionPermissions && (
                    currentUser.sectionPermissions.includes('all') ||
                    currentUser.sectionPermissions.includes(section)
                );
                return hasGradePermission && hasSectionPermission;
            }
            return false;
        }

        function hasPermissionForGrade(grade) {
            if (!currentUser) return false;
            if (currentUser.role === 'admin') return true;
            if (currentUser.role === 'teacher') {
                return currentUser.permissions && (
                    currentUser.permissions.includes('all') || 
                    currentUser.permissions.includes(grade)
                );
            }
            return false;
        }

        // Get available grades for current user
        function getAvailableGrades() {
            if (!currentUser) return [];
            if (currentUser.role === 'admin') {
                return ['grade1', 'grade2', 'grade3', 'grade4', 'grade5', 'grade6', 
                       'grade7', 'grade8', 'grade9', 'grade10', 'grade11', 'grade12'];
            }
            if (currentUser.role === 'teacher') {
                if (currentUser.permissions && currentUser.permissions.includes('all')) {
                    return ['grade1', 'grade2', 'grade3', 'grade4', 'grade5', 'grade6', 
                           'grade7', 'grade8', 'grade9', 'grade10', 'grade11', 'grade12'];
                }
                return currentUser.permissions || [];
            }
            return [];
        }

        // Get available sections for current user - updated for 10 sections
        function getAvailableSections() {
            if (!currentUser) return [];
            if (currentUser.role === 'admin') {
                return ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10'];
            }
            if (currentUser.role === 'teacher') {
                if (currentUser.sectionPermissions && currentUser.sectionPermissions.includes('all')) {
                    return ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10'];
                }
                return currentUser.sectionPermissions || [];
            }
            return [];
        }

        // Populate grade selects based on user permissions
        function populateGradeSelects() {
            const availableGrades = getAvailableGrades();
            const gradeNames = {
                'grade1': 'الصف الأول', 'grade2': 'الصف الثاني', 'grade3': 'الصف الثالث', 'grade4': 'الصف الرابع',
                'grade5': 'الصف الخامس', 'grade6': 'الصف السادس', 'grade7': 'الصف السابع', 'grade8': 'الصف الثامن',
                'grade9': 'الصف التاسع', 'grade10': 'الصف العاشر', 'grade11': 'الصف الحادي عشر', 'grade12': 'الصف الثاني عشر'
            };

            // Get all grade select elements
            const gradeSelects = [
                'plans-grade-select', 'students-grade-select', 'attendance-grade-select',
                'report-grade-select', 'plan-grade', 'student-grade'
            ];

            gradeSelects.forEach(selectId => {
                const selectElement = document.getElementById(selectId);
                if (selectElement) {
                    // Keep first option
                    const firstOption = selectElement.children[0];
                    selectElement.innerHTML = '';
                    selectElement.appendChild(firstOption);

                    // Add available grades
                    availableGrades.forEach(gradeId => {
                        const option = document.createElement('option');
                        option.value = gradeId;
                        option.textContent = gradeNames[gradeId];
                        selectElement.appendChild(option);
                    });
                }
            });

            // Populate grade permissions in user modal
            const gradePermissionsDiv = document.getElementById('grade-permissions');
            if (gradePermissionsDiv) {
                gradePermissionsDiv.innerHTML = '<h5 class="font-medium text-sm mb-2">الصفوف المسموحة:</h5>';
                Object.entries(gradeNames).forEach(([gradeId, gradeName]) => {
                    const label = document.createElement('label');
                    label.className = 'flex items-center space-x-2 space-x-reverse';
                    label.innerHTML = `
                        <input type="checkbox" value="${gradeId}" class="user-permissions">
                        <span class="text-sm">${gradeName}</span>
                    `;
                    gradePermissionsDiv.appendChild(label);
                });
            }
        }

        // Update UI based on user role and display section info
        function updateUIBasedOnUserRole() {
            if (!currentUser) return;
            
            const isAdmin = currentUser.role === 'admin';
            const adminOnlyElements = document.querySelectorAll('.admin-only');
            
            // Show/hide admin-only elements
            adminOnlyElements.forEach(element => {
                if (isAdmin) {
                    element.classList.remove('teacher-hidden');
                } else {
                    element.classList.add('teacher-hidden');
                }
            });
            
            // Update user role badge
            const roleBadge = document.getElementById('user-role-badge');
            if (roleBadge) {
                roleBadge.textContent = isAdmin ? 'مدير' : 'معلم';
                roleBadge.className = isAdmin ? 
                    'mr-2 px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-xs' :
                    'mr-2 px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs';
            }
            
            // Show section badge for teachers
            const sectionBadge = document.getElementById('user-section-badge');
            if (sectionBadge && !isAdmin && currentUser.sectionPermissions) {
                const sections = currentUser.sectionPermissions.includes('all') ? 
                    'جميع الشعب' : 
                    currentUser.sectionPermissions.join(', ');
                sectionBadge.textContent = `الشعب: ${sections}`;
                sectionBadge.classList.remove('hidden');
            } else if (sectionBadge) {
                sectionBadge.classList.add('hidden');
            }
            
            // Populate grade selects based on permissions
            populateGradeSelects();
        }

        // Enhanced authentication to handle section permissions
        async function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('login-btn');
            const loginText = document.getElementById('login-text');
            const loginSpinner = document.getElementById('login-spinner');
            const loginError = document.getElementById('login-error');
            
            // Show loading
            loginText.classList.add('hidden');
            loginSpinner.classList.remove('hidden');
            loginError.classList.add('hidden');
            
            try {
                // Check credentials against Firebase
                const usersSnapshot = await db.collection('users').where('username', '==', username).get();
                
                if (!usersSnapshot.empty) {
                    const userData = usersSnapshot.docs[0].data();
                    if (userData.password === password) {
                        // Success
                        currentUser = {
                            id: usersSnapshot.docs[0].id,
                            ...userData
                        };
                        
                        document.getElementById('user-name').textContent = userData.name;
                        document.getElementById('login-screen').classList.add('hidden');
                        document.getElementById('dashboard').classList.remove('hidden');
                        updateUIBasedOnUserRole();
                        loadRealtimeData();
                        return;
                    }
                }
                
                // Try default admin credentials if Firebase fails
                if (username === 'admin' && password === 'admin123') {
                    currentUser = {
                        id: 'admin',
                        name: 'المدير',
                        username: 'admin',
                        role: 'admin',
                        permissions: ['all'],
                        sectionPermissions: ['all']
                    };
                    
                    document.getElementById('user-name').textContent = 'المدير';
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    updateUIBasedOnUserRole();
                    loadRealtimeData();
                } else {
                    throw new Error('Invalid credentials');
                }
                
            } catch (error) {
                console.error('Login error:', error);
                loginError.classList.remove('hidden');
            } finally {
                loginText.classList.remove('hidden');
                loginSpinner.classList.add('hidden');
            }
        }

        function handleLogout() {
            currentUser = null;
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('login-form').reset();
        }

        // Tab functionality
        function handleTabClick() {
            const tabName = this.getAttribute('data-tab');
            
            // Check if user has permission to access this tab
            if (tabName === 'users' && currentUser && currentUser.role !== 'admin') {
                showErrorMessage('ليس لديك صلاحية للوصول إلى إدارة المستخدمين');
                return;
            }
            
            switchTab(tabName);
        }

        function switchTab(tabName) {
            // Check if user has permission to access this tab
            if (tabName === 'users' && currentUser && currentUser.role !== 'admin') {
                return;
            }
            
            // Update button states
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('bg-gray-200', 'dark:bg-gray-700');
            });
            
            const activeButton = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
                activeButton.classList.remove('bg-gray-200', 'dark:bg-gray-700');
            }
            
            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            const targetTab = document.getElementById(tabName + '-tab');
            if (targetTab) {
                targetTab.classList.remove('hidden');
            }
        }

        // Real-time data loading
        function loadRealtimeData() {
            loadPlansRealtime();
            loadUsersRealtime();
            loadStudentsRealtime();
            loadActivitiesRealtime();
            loadReportsRealtime();
        }

        function loadPlansRealtime() {
            let query = db.collection('weeklyPlans');
            
            // If user is a teacher, only load their own plans
            if (currentUser && currentUser.role === 'teacher') {
                query = query.where('teacherId', '==', currentUser.id);
            }
            
            query.onSnapshot((snapshot) => {
                allPlans = [];
                snapshot.forEach((doc) => {
                    const planData = doc.data();
                    // Additional section-based filtering for teachers
                    if (currentUser && currentUser.role === 'teacher') {
                        if (hasPermissionForGradeAndSection(planData.grade, planData.section)) {
                            allPlans.push({
                                id: doc.id,
                                ...planData
                            });
                        }
                    } else {
                        allPlans.push({
                            id: doc.id,
                            ...planData
                        });
                    }
                });
                
                updatePlansCount();
                displayPlans();
                hideLoading('plans');
            });
        }

        function loadStudentsRealtime() {
            db.collection('students').onSnapshot((snapshot) => {
                allStudents = [];
                snapshot.forEach((doc) => {
                    const studentData = doc.data();
                    // If user is a teacher, only load students from grades and sections they have permission for
                    if (currentUser && currentUser.role === 'teacher') {
                        if (hasPermissionForGradeAndSection(studentData.grade, studentData.section)) {
                            allStudents.push({
                                id: doc.id,
                                ...studentData
                            });
                        }
                    } else {
                        // Admin can see all students
                        allStudents.push({
                            id: doc.id,
                            ...studentData
                        });
                    }
                });
                
                updateStudentsCount();
                displayStudents();
                populateStudentSelects();
                hideLoading('students');
            });
        }

        function loadReportsRealtime() {
            let query = db.collection('studentReports');
            
            // If user is a teacher, only load reports for their sections
            if (currentUser && currentUser.role === 'teacher') {
                query = query.where('teacherId', '==', currentUser.id);
            }
            
            query.onSnapshot((snapshot) => {
                allReports = [];
                snapshot.forEach((doc) => {
                    allReports.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                updateReportsCount();
                hideLoading('reports');
            });
        }

        function loadUsersRealtime() {
            db.collection('users').onSnapshot((snapshot) => {
                allUsers = [];
                snapshot.forEach((doc) => {
                    const userData = doc.data();
                    if (userData.role === 'teacher') {
                        allUsers.push({
                            id: doc.id,
                            ...userData
                        });
                    }
                });
                
                updateTeachersCount();
                displayUsers();
                hideLoading('users');
            });
        }

        function loadActivitiesRealtime() {
            db.collection('activities').onSnapshot((snapshot) => {
                allActivities = [];
                snapshot.forEach((doc) => {
                    allActivities.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                updateActivitiesCount();
                displayActivities();
                hideLoading('activities');
            });
        }

        // Enhanced display functions to include sections
        function displayPlans() {
            const filteredPlans = filterPlansBySearch();
            const tableBody = document.getElementById('plans-table-body');
            const tableContainer = document.getElementById('plans-table-container');
            const emptyState = document.getElementById('plans-empty');
            
            if (filteredPlans.length === 0) {
                tableContainer.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            tableContainer.classList.remove('hidden');
            
            // Sort plans by grade, section, date, and day
            const dayOrder = ['الاتنين', 'الثلاثاء', 'الاربعاء', 'الخميس', 'الجمعة'];
            filteredPlans.sort((a, b) => {
                if (a.grade !== b.grade) return a.grade.localeCompare(b.grade);
                if (a.section !== b.section) return a.section.localeCompare(b.section);
                if (a.planDate !== b.planDate) return (a.planDate || '').localeCompare(b.planDate || '');
                return dayOrder.indexOf(a.day) - dayOrder.indexOf(b.day);
            });
            
            tableBody.innerHTML = '';
            filteredPlans.forEach(plan => {
                const row = tableBody.insertRow();
                row.className = `hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors ${plan.archived ? 'archived-plan' : ''}`;
                
                // Highlight search terms
                const subjectText = highlightSearchTerm(plan.subject, currentSearchFilters.subject);
                const topicText = highlightSearchTerm(plan.topic, currentSearchFilters.topic);
                const teacherText = highlightSearchTerm(plan.teacherName || 'غير محدد', currentSearchFilters.teacher);
                
                row.innerHTML = `
                    <td class="border border-gray-300 dark:border-gray-600 px-4 py-2">
                        <span class="bg-primary text-white px-2 py-1 rounded text-xs">${getGradeName(plan.grade)}</span>
                    </td>
                    <td class="border border-gray-300 dark:border-gray-600 px-4 py-2">
                        <span class="section-badge text-xs">${plan.section}</span>
                    </td>
                    <td class="border border-gray-300 dark:border-gray-600 px-4 py-2">${plan.planDate || ''}</td>
                    <td class="border border-gray-300 dark:border-gray-600 px-4 py-2 font-medium">${plan.day}</td>
                    <td class="border border-gray-300 dark:border-gray-600 px-4 py-2">${subjectText}</td>
                    <td class="border border-gray-300 dark:border-gray-600 px-4 py-2">${topicText}</td>
                    <td class="border border-gray-300 dark:border-gray-600 px-4 py-2">${plan.activities}</td>
                    <td class="border border-gray-300 dark:border-gray-600 px-4 py-2">${teacherText}</td>
                    <td class="border border-gray-300 dark:border-gray-600 px-4 py-2">
                        <span class="px-2 py-1 rounded text-xs ${plan.archived ? 'bg-gray-100 text-gray-600' : 'bg-green-100 text-green-600'}">
                            ${plan.archived ? 'مؤرشف' : 'نشط'}
                        </span>
                    </td>
                    <td class="border border-gray-300 dark:border-gray-600 px-4 py-2">
                        <div class="flex space-x-1 space-x-reverse">
                            ${plan.teacherId === currentUser.id || currentUser.role === 'admin' ? `
                                <button onclick="editPlan('${plan.id}')" class="text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="${plan.archived ? 'unarchivePlan' : 'archivePlan'}('${plan.id}')" class="text-yellow-600 hover:text-yellow-800">
                                    <i class="fas fa-${plan.archived ? 'undo' : 'archive'}"></i>
                                </button>
                                <button onclick="deletePlan('${plan.id}')" class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : `
                                <span class="text-gray-400 text-xs">عرض فقط</span>
                            `}
                        </div>
                    </td>
                `;
            });
        }

        function displayStudents() {
            const filteredStudents = filterStudentsByGradeAndSection();
            const studentsGrid = document.getElementById('students-grid');
            const emptyState = document.getElementById('students-empty');
            
            if (filteredStudents.length === 0) {
                studentsGrid.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            studentsGrid.classList.remove('hidden');
            
            studentsGrid.innerHTML = '';
            filteredStudents.forEach(student => {
                const studentCard = createStudentCard(student);
                studentsGrid.appendChild(studentCard);
            });
        }

        function createStudentCard(student) {
            const card = document.createElement('div');
            card.className = 'student-card bg-white dark:bg-gray-700 rounded-lg p-6 shadow-lg';
            
            const statusBadge = getGradeBadge(student.grade);
            const sectionBadge = `<span class="section-badge text-xs mr-2">${student.section}</span>`;
            const whatsappBtn = student.parentPhone ? 
                `<button onclick="sendWhatsAppToParent('${student.parentPhone}', '${student.name}')" 
                         class="whatsapp-btn text-white px-3 py-1 rounded text-sm hover:bg-opacity-90 transition-colors">
                    <i class="fab fa-whatsapp ml-1"></i>
                    واتساب
                 </button>` : '';
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-gray-100">${student.name}</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400">رقم الأساس: ${student.studentId}</p>
                    </div>
                    <div class="flex items-center">
                        ${statusBadge}
                        ${sectionBadge}
                    </div>
                </div>
                
                <div class="space-y-2 mb-4">
                    <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                        <i class="fas fa-user-tie ml-2 text-primary"></i>
                        <span>${student.parentName || 'غير محدد'}</span>
                    </div>
                    <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                        <i class="fas fa-phone ml-2 text-primary"></i>
                        <span dir="ltr">${student.parentPhone || 'غير محدد'}</span>
                    </div>
                </div>
                
                <div class="flex justify-between items-center">
                    <div class="flex space-x-2 space-x-reverse">
                        <button onclick="editStudent('${student.id}')" class="text-blue-600 hover:text-blue-800 dark:text-blue-400">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteStudent('${student.id}')" class="text-red-600 hover:text-red-800 dark:text-red-400">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    ${whatsappBtn}
                </div>
            `;
            
            return card;
        }

        function filterStudentsByGradeAndSection() {
            const selectedGrade = document.getElementById('students-grade-select').value;
            const selectedSection = document.getElementById('students-section-select').value;
            
            let filtered = allStudents;
            
            if (selectedGrade) {
                filtered = filtered.filter(student => student.grade === selectedGrade);
            }
            
            if (selectedSection) {
                filtered = filtered.filter(student => student.section === selectedSection);
            }
            
            return filtered;
        }

        function filterStudents() {
            displayStudents();
        }

        // Enhanced search to include sections
        function filterPlansBySearch() {
            let filteredPlans = [...allPlans];
            
            // Filter by grade
            if (currentSearchFilters.grade) {
                filteredPlans = filteredPlans.filter(plan => plan.grade === currentSearchFilters.grade);
            }
            
            // Filter by section
            if (currentSearchFilters.section) {
                filteredPlans = filteredPlans.filter(plan => plan.section === currentSearchFilters.section);
            }
            
            // Other filters remain the same...
            if (currentSearchFilters.subject) {
                filteredPlans = filteredPlans.filter(plan => 
                    plan.subject.toLowerCase().includes(currentSearchFilters.subject)
                );
            }
            
            if (currentSearchFilters.topic) {
                filteredPlans = filteredPlans.filter(plan => 
                    plan.topic.toLowerCase().includes(currentSearchFilters.topic)
                );
            }
            
            if (currentSearchFilters.teacher) {
                filteredPlans = filteredPlans.filter(plan => 
                    (plan.teacherName || '').toLowerCase().includes(currentSearchFilters.teacher)
                );
            }
            
            if (currentSearchFilters.dateFrom) {
                filteredPlans = filteredPlans.filter(plan => 
                    plan.planDate >= currentSearchFilters.dateFrom
                );
            }
            
            if (currentSearchFilters.dateTo) {
                filteredPlans = filteredPlans.filter(plan => 
                    plan.planDate <= currentSearchFilters.dateTo
                );
            }
            
            if (currentSearchFilters.status) {
                if (currentSearchFilters.status === 'active') {
                    filteredPlans = filteredPlans.filter(plan => !plan.archived);
                } else if (currentSearchFilters.status === 'archived') {
                    filteredPlans = filteredPlans.filter(plan => plan.archived);
                }
            }
            
            return filteredPlans;
        }

        function searchPlans() {
            const filters = {
                grade: document.getElementById('plans-grade-select').value,
                section: document.getElementById('plans-section-select').value,
                subject: document.getElementById('plans-subject-search').value.toLowerCase(),
                topic: document.getElementById('plans-topic-search').value.toLowerCase(),
                teacher: document.getElementById('plans-teacher-search').value.toLowerCase(),
                dateFrom: document.getElementById('plans-date-from').value,
                dateTo: document.getElementById('plans-date-to').value,
                status: document.getElementById('plans-status-filter').value
            };
            
            currentSearchFilters = filters;
            displayPlans();
        }

        // Enhanced plan submission with section
        async function handlePlanSubmit(e) {
            e.preventDefault();
            
            const form = e.target;
            const editId = form.dataset.editId;
            const isEdit = !!editId;
            const planGrade = document.getElementById('plan-grade').value;
            const planSection = document.getElementById('plan-section').value;
            
            // Check if user has permission for this grade and section
            if (!hasPermissionForGradeAndSection(planGrade, planSection)) {
                showErrorMessage('ليس لديك صلاحية لإنشاء خطط لهذا الصف والشعبة');
                return;
            }
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const submitText = document.getElementById('plan-submit-text');
            const submitSpinner = document.getElementById('plan-submit-spinner');
            
            // Show loading
            submitText.classList.add('hidden');
            submitSpinner.classList.remove('hidden');
            
            try {
                const planData = {
                    grade: planGrade,
                    section: planSection,
                    planDate: document.getElementById('plan-date').value,
                    day: document.getElementById('plan-day').value,
                    subject: document.getElementById('plan-subject').value,
                    topic: document.getElementById('plan-topic').value,
                    activities: document.getElementById('plan-activities').value,
                    teacherName: currentUser.name,
                    teacherId: currentUser.id,
                    archived: false,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (isEdit) {
                    // Check if user can edit this plan
                    const existingPlan = allPlans.find(p => p.id === editId);
                    if (existingPlan && existingPlan.teacherId !== currentUser.id && currentUser.role !== 'admin') {
                        showErrorMessage('ليس لديك صلاحية لتعديل هذه الخطة');
                        return;
                    }
                    
                    // Update existing plan
                    await db.collection('weeklyPlans').doc(editId).update(planData);
                    showSuccessMessage('تم تحديث الخطة بنجاح');
                } else {
                    // Add new plan
                    planData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('weeklyPlans').add(planData);
                    showSuccessMessage('تمت إضافة الخطة بنجاح');
                }
                
                closePlanModal();
                
            } catch (error) {
                console.error('Error saving plan:', error);
                showErrorMessage('حدث خطأ في ' + (isEdit ? 'تحديث' : 'إضافة') + ' الخطة');
            } finally {
                submitText.classList.remove('hidden');
                submitSpinner.classList.add('hidden');
            }
        }

        // Enhanced student submission with section
        async function handleStudentSubmit(e) {
            e.preventDefault();
            
            const studentGrade = document.getElementById('student-grade').value;
            const studentSection = document.getElementById('student-section').value;
            
            // Check if user has permission for this grade and section
            if (!hasPermissionForGradeAndSection(studentGrade, studentSection)) {
                showErrorMessage('ليس لديك صلاحية لإضافة طلاب في هذا الصف والشعبة');
                return;
            }
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const submitText = document.getElementById('student-submit-text');
            const submitSpinner = document.getElementById('student-submit-spinner');
            
            // Show loading
            submitText.classList.add('hidden');
            submitSpinner.classList.remove('hidden');
            
            try {
                const studentData = {
                    studentId: document.getElementById('student-id').value,
                    name: document.getElementById('student-name').value,
                    grade: studentGrade,
                    section: studentSection,
                    parentPhone: document.getElementById('parent-phone').value,
                    parentName: document.getElementById('parent-name').value || '',
                    notes: document.getElementById('student-notes').value || '',
                    createdBy: currentUser.id,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('students').add(studentData);
                
                showSuccessMessage('تمت إضافة الطالب بنجاح');
                closeStudentModal();
                document.getElementById('student-form').reset();
                
            } catch (error) {
                console.error('Error adding student:', error);
                showErrorMessage('حدث خطأ في إضافة الطالب');
            } finally {
                submitText.classList.remove('hidden');
                submitSpinner.classList.add('hidden');
            }
        }

        // Report generation and management
        function populateStudentSelects() {
            const studentSelect = document.getElementById('report-student');
            if (!studentSelect) return;
            
            // Clear existing options except first
            const firstOption = studentSelect.children[0];
            studentSelect.innerHTML = '';
            studentSelect.appendChild(firstOption);
            
            // Add students based on user permissions
            const availableStudents = allStudents.filter(student => {
                if (currentUser.role === 'admin') return true;
                return hasPermissionForGradeAndSection(student.grade, student.section);
            });
            
            availableStudents.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.name} - ${getGradeName(student.grade)} ${student.section}`;
                studentSelect.appendChild(option);
            });
        }

        async function handleReportSubmit(e) {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const submitText = document.getElementById('report-submit-text');
            const submitSpinner = document.getElementById('report-submit-spinner');
            
            // Show loading
            submitText.classList.add('hidden');
            submitSpinner.classList.remove('hidden');
            
            try {
                const studentId = document.getElementById('report-student').value;
                const student = allStudents.find(s => s.id === studentId);
                
                if (!student) {
                    showErrorMessage('الطالب غير موجود');
                    return;
                }
                
                // Check permissions
                if (!hasPermissionForGradeAndSection(student.grade, student.section)) {
                    showErrorMessage('ليس لديك صلاحية لإنشاء تقارير لهذا الطالب');
                    return;
                }
                
                const reportData = {
                    studentId: studentId,
                    studentName: student.name,
                    grade: student.grade,
                    section: student.section,
                    subject: document.getElementById('report-subject').value,
                    gradeScore: parseInt(document.getElementById('report-grade').value),
                    date: document.getElementById('report-date').value,
                    strengths: document.getElementById('report-strengths').value || '',
                    improvements: document.getElementById('report-improvements').value || '',
                    notes: document.getElementById('report-notes').value || '',
                    teacherId: currentUser.id,
                    teacherName: currentUser.name,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('studentReports').add(reportData);
                
                showSuccessMessage('تم حفظ التقرير بنجاح');
                closeReportModal();
                document.getElementById('report-form').reset();
                
            } catch (error) {
                console.error('Error saving report:', error);
                showErrorMessage('حدث خطأ في حفظ التقرير');
            } finally {
                submitText.classList.remove('hidden');
                submitSpinner.classList.add('hidden');
            }
        }

        async function generateReport() {
            const grade = document.getElementById('report-grade-select').value;
            const section = document.getElementById('report-section-select').value;
            const period = document.getElementById('report-period-select').value;
            
            if (!grade || !section || !period) {
                showErrorMessage('يرجى اختيار الصف والشعبة وفترة التقرير');
                return;
            }
            
            if (!hasPermissionForGradeAndSection(grade, section)) {
                showErrorMessage('ليس لديك صلاحية للوصول إلى هذا الصف والشعبة');
                return;
            }
            
            const loadingDiv = document.getElementById('reports-loading');
            const containerDiv = document.getElementById('reports-container');
            const emptyDiv = document.getElementById('reports-empty');
            
            loadingDiv.classList.remove('hidden');
            containerDiv.classList.add('hidden');
            emptyDiv.classList.add('hidden');
            
            try {
                // Calculate date range based on period
                const endDate = new Date();
                const startDate = new Date();
                
                switch (period) {
                    case 'weekly':
                        startDate.setDate(endDate.getDate() - 7);
                        break;
                    case 'monthly':
                        startDate.setMonth(endDate.getMonth() - 1);
                        break;
                    case 'yearly':
                        startDate.setFullYear(endDate.getFullYear() - 1);
                        break;
                }
                
                // Get reports for the specified period, grade, and section
                const reportsQuery = await db.collection('studentReports')
                    .where('grade', '==', grade)
                    .where('section', '==', section)
                    .where('date', '>=', startDate.toISOString().split('T')[0])
                    .where('date', '<=', endDate.toISOString().split('T')[0])
                    .get();
                
                const periodReports = [];
                reportsQuery.forEach(doc => {
                    periodReports.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Get students for this grade and section
                const sectionStudents = allStudents.filter(s => s.grade === grade && s.section === section);
                
                if (sectionStudents.length === 0) {
                    showErrorMessage('لا يوجد طلاب في هذا الصف والشعبة');
                    return;
                }
                
                // Generate summary report for each student
                const studentSummaries = sectionStudents.map(student => {
                    const studentReports = periodReports.filter(r => r.studentId === student.id);
                    
                    let averageGrade = 0;
                    let subjectCount = 0;
                    
                    if (studentReports.length > 0) {
                        const totalGrades = studentReports.reduce((sum, report) => sum + (report.gradeScore || 0), 0);
                        averageGrade = Math.round(totalGrades / studentReports.length);
                        subjectCount = studentReports.length;
                    }
                    
                    return {
                        student: student,
                        averageGrade: averageGrade,
                        subjectCount: subjectCount,
                        reports: studentReports
                    };
                });
                
                displayReportSummaries(studentSummaries, period, grade, section);
                
            } catch (error) {
                console.error('Error generating report:', error);
                showErrorMessage('حدث خطأ في إنشاء التقرير');
            } finally {
                loadingDiv.classList.add('hidden');
            }
        }

        function displayReportSummaries(summaries, period, grade, section) {
            const containerDiv = document.getElementById('reports-container');
            const gridDiv = document.getElementById('reports-grid');
            const emptyDiv = document.getElementById('reports-empty');
            
            if (summaries.length === 0) {
                containerDiv.classList.add('hidden');
                emptyDiv.classList.remove('hidden');
                return;
            }
            
            emptyDiv.classList.add('hidden');
            containerDiv.classList.remove('hidden');
            
            gridDiv.innerHTML = '';
            
            summaries.forEach(summary => {
                const reportCard = createReportCard(summary, period);
                gridDiv.appendChild(reportCard);
            });
        }

        function createReportCard(summary, period) {
            const { student, averageGrade, subjectCount, reports } = summary;
            
            let gradeClass = 'grade-poor';
            let gradeText = 'ضعيف';
            
            if (averageGrade >= 90) {
                gradeClass = 'grade-excellent';
                gradeText = 'ممتاز';
            } else if (averageGrade >= 80) {
                gradeClass = 'grade-good';
                gradeText = 'جيد';
            } else if (averageGrade >= 60) {
                gradeClass = 'grade-average';
                gradeText = 'متوسط';
            }
            
            const periodText = {
                'weekly': 'الأسبوع الماضي',
                'monthly': 'الشهر الماضي',
                'yearly': 'السنة الماضية'
            };
            
            const card = document.createElement('div');
            card.className = 'report-card dark:bg-gray-700';
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-gray-100">${student.name}</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400">${getGradeName(student.grade)} - الشعبة ${student.section}</p>
                        <p class="text-xs text-gray-500">رقم الأساس: ${student.studentId}</p>
                    </div>
                    <div class="text-center">
                        <div class="w-16 h-16 rounded-full ${gradeClass} flex items-center justify-center text-white font-bold text-lg mb-2">
                            ${averageGrade}
                        </div>
                        <span class="text-xs text-gray-600 dark:text-gray-400">${gradeText}</span>
                    </div>
                </div>
                
                <div class="space-y-2 mb-4">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600 dark:text-gray-400">فترة التقرير:</span>
                        <span class="font-medium">${periodText[period]}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600 dark:text-gray-400">عدد المواد:</span>
                        <span class="font-medium">${subjectCount}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600 dark:text-gray-400">المعدل العام:</span>
                        <span class="font-medium">${averageGrade}/100</span>
                    </div>
                </div>
                
                ${reports.length > 0 ? `
                    <div class="border-t border-gray-200 dark:border-gray-600 pt-4">
                        <h5 class="text-sm font-medium mb-2">تفاصيل المواد:</h5>
                        <div class="space-y-1 max-h-32 overflow-y-auto">
                            ${reports.map(report => `
                                <div class="flex justify-between text-xs">
                                    <span>${report.subject}</span>
                                    <span class="font-medium">${report.gradeScore}/100</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : `
                    <div class="text-center py-4 text-gray-500 text-sm">
                        لا توجد تقارير للفترة المحددة
                    </div>
                `}
                
                <div class="flex justify-center mt-4">
                    <button onclick="sendStudentReportViaWhatsApp('${student.id}', '${averageGrade}', '${subjectCount}')" 
                            class="whatsapp-btn text-white px-4 py-2 rounded text-sm hover:bg-opacity-90 transition-colors">
                        <i class="fab fa-whatsapp ml-2"></i>
                        إرسال للولي
                    </button>
                </div>
            `;
            
            return card;
        }

        async function sendStudentReportViaWhatsApp(studentId, averageGrade, subjectCount) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student || !student.parentPhone) {
                showErrorMessage('رقم ولي الأمر غير متوفر');
                return;
            }
            
            const period = document.getElementById('report-period-select').value;
            const periodText = {
                'weekly': 'الأسبوع الماضي',
                'monthly': 'الشهر الماضي', 
                'yearly': 'السنة الماضية'
            };
            
            let gradeText = 'ضعيف';
            if (averageGrade >= 90) gradeText = 'ممتاز';
            else if (averageGrade >= 80) gradeText = 'جيد';
            else if (averageGrade >= 60) gradeText = 'متوسط';
            
            const message = `مرحباً ${student.parentName || 'ولي الأمر'},

هذا تقرير أداء الطالب ${student.name} للفترة ${periodText[period]}:

📊 المعدل العام: ${averageGrade}/100 (${gradeText})
📚 عدد المواد المُقيمة: ${subjectCount}
🏫 الصف: ${getGradeName(student.grade)} - الشعبة ${student.section}

نشكركم على متابعتكم وثقتكم.

مدرسة الثروات الوطنية الخاصة`;
            
            const whatsappUrl = `https://wa.me/${student.parentPhone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        async function sendReportsViaWhatsApp() {
            const grade = document.getElementById('report-grade-select').value;
            const section = document.getElementById('report-section-select').value;
            
            if (!grade || !section) {
                showErrorMessage('يرجى إنشاء التقرير أولاً');
                return;
            }
            
            // Get all students in the current report
            const reportCards = document.querySelectorAll('#reports-grid .report-card');
            let sentCount = 0;
            
            reportCards.forEach((card, index) => {
                const whatsappBtn = card.querySelector('[onclick*="sendStudentReportViaWhatsApp"]');
                if (whatsappBtn) {
                    setTimeout(() => {
                        whatsappBtn.click();
                    }, index * 1000); // 1 second delay between each message
                    sentCount++;
                }
            });
            
            if (sentCount > 0) {
                showSuccessMessage(`سيتم فتح ${sentCount} محادثة واتساب`);
            } else {
                showErrorMessage('لا توجد تقارير لإرسالها');
            }
        }

        // Enhanced attendance with sections
        function handleAttendanceGradeSelect() {
            const selectedGrade = document.getElementById('attendance-grade-select').value;
            const selectedSection = document.getElementById('attendance-section-select').value;
            const container = document.getElementById('attendance-container');
            
            if (selectedGrade && selectedSection && hasPermissionForGradeAndSection(selectedGrade, selectedSection)) {
                container.classList.remove('hidden');
                loadStudentsForAttendance(selectedGrade, selectedSection);
            } else if (selectedGrade && selectedSection && !hasPermissionForGradeAndSection(selectedGrade, selectedSection)) {
                showErrorMessage('ليس لديك صلاحية للوصول إلى هذا الصف والشعبة');
                container.classList.add('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        function loadStudentsForAttendance(grade, section) {
            const studentsContainer = document.getElementById('students-attendance');
            const loadingDiv = document.getElementById('attendance-loading');
            
            loadingDiv.classList.remove('hidden');
            
            setTimeout(() => {
                const students = allStudents.filter(s => s.grade === grade && s.section === section);
                
                studentsContainer.innerHTML = '';
                students.forEach((student, index) => {
                    const studentCard = document.createElement('div');
                    studentCard.className = 'bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border';
                    studentCard.innerHTML = `
                        <h4 class="font-semibold mb-3">${student.name}</h4>
                        <p class="text-xs text-gray-500 mb-3">رقم الأساس: ${student.studentId}</p>
                        <div class="flex space-x-2 space-x-reverse">
                            <button class="attendance-btn attendance-present text-white px-3 py-1 rounded text-sm" data-status="present" data-student="${student.id}">
                                حاضر
                            </button>
                            <button class="attendance-btn attendance-absent text-white px-3 py-1 rounded text-sm" data-status="absent" data-student="${student.id}">
                                غائب
                            </button>
                            <button class="attendance-btn attendance-late text-white px-3 py-1 rounded text-sm" data-status="late" data-student="${student.id}">
                                متأخر
                            </button>
                        </div>
                    `;
                    studentsContainer.appendChild(studentCard);
                });
                
                // Add click handlers for attendance buttons
                document.querySelectorAll('.attendance-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const studentId = this.getAttribute('data-student');
                        const status = this.getAttribute('data-status');
                        
                        // Remove active state from all buttons for this student
                        document.querySelectorAll(`[data-student="${studentId}"]`).forEach(button => {
                            button.classList.remove('ring-2', 'ring-white');
                        });
                        
                        // Add active state to clicked button
                        this.classList.add('ring-2', 'ring-white');
                    });
                });
                
                loadingDiv.classList.add('hidden');
            }, 1000);
        }

        async function saveAttendance() {
            const grade = document.getElementById('attendance-grade-select').value;
            const section = document.getElementById('attendance-section-select').value;
            const date = document.getElementById('attendance-date').value;
            
            if (!grade || !section || !date) {
                showErrorMessage('يرجى اختيار الصف والشعبة والتاريخ');
                return;
            }
            
            if (!hasPermissionForGradeAndSection(grade, section)) {
                showErrorMessage('ليس لديك صلاحية للوصول إلى هذا الصف والشعبة');
                return;
            }
            
            try {
                const attendanceData = [];
                document.querySelectorAll('.attendance-btn.ring-2').forEach(btn => {
                    attendanceData.push({
                        studentId: btn.getAttribute('data-student'),
                        status: btn.getAttribute('data-status')
                    });
                });
                
                const docData = {
                    grade: grade,
                    section: section,
                    date: date,
                    attendance: attendanceData,
                    teacherId: currentUser.id,
                    teacherName: currentUser.name,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('attendance').doc(`${grade}_${section}_${date}`).set(docData);
                
                showSuccessMessage('تم حفظ بيانات الحضور بنجاح');
                
            } catch (error) {
                console.error('Error saving attendance:', error);
                showErrorMessage('حدث خطأ في حفظ بيانات الحضور');
            }
        }

        // Enhanced user submission with section permissions
        async function handleUserSubmit(e) {
            e.preventDefault();
            
            const form = e.target;
            const editId = form.dataset.editId;
            const isEdit = !!editId;
            
            const submitBtn = document.getElementById('user-submit-btn');
            const submitText = document.getElementById('user-submit-text');
            const submitSpinner = document.getElementById('user-submit-spinner');
            
            // Validate form fields first
            const name = document.getElementById('modal-user-name').value.trim();
            const username = document.getElementById('modal-user-username').value.trim();
            const password = document.getElementById('modal-user-password').value;
            const role = document.getElementById('modal-user-role').value;
            
            if (!name || !username || !role) {
                showErrorMessage('يرجى ملء جميع الحقول المطلوبة');
                return;
            }
            
            if (!isEdit && !password) {
                showErrorMessage('كلمة المرور مطلوبة للمستخدمين الجدد');
                return;
            }
            
            // Show loading
            submitText.classList.add('hidden');
            submitSpinner.classList.remove('hidden');
            submitBtn.disabled = true;
            
            try {
                // Check if username already exists (only for new users)
                if (!isEdit) {
                    const existingUser = await db.collection('users').where('username', '==', username).get();
                    if (!existingUser.empty) {
                        showErrorMessage('اسم المستخدم موجود بالفعل');
                        return;
                    }
                }
                
                const permissions = Array.from(document.querySelectorAll('.user-permissions:checked'))
                    .map(checkbox => checkbox.value);
                    
                const sectionPermissions = Array.from(document.querySelectorAll('.section-permissions:checked'))
                    .map(checkbox => checkbox.value);
                
                const userData = {
                    name: name,
                    username: username,
                    role: role,
                    permissions: permissions,
                    sectionPermissions: sectionPermissions,
                    status: 'active',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Only include password if it's provided
                if (password) {
                    userData.password = password;
                }
                
                if (isEdit) {
                    // Update existing user
                    await db.collection('users').doc(editId).update(userData);
                    showSuccessMessage('تم تحديث المستخدم بنجاح');
                } else {
                    // Add new user
                    userData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('users').add(userData);
                    showSuccessMessage('تمت إضافة المستخدم بنجاح');
                }
                
                closeUserModal();
                
            } catch (error) {
                console.error('Error saving user:', error);
                showErrorMessage('حدث خطأ في ' + (isEdit ? 'تحديث' : 'إضافة') + ' المستخدم: ' + error.message);
            } finally {
                // Always hide loading and enable button
                submitText.classList.remove('hidden');
                submitSpinner.classList.add('hidden');
                submitBtn.disabled = false;
            }
        }

        // Activities functionality remains the same...
        function displayActivities() {
            const filteredActivities = filterActivitiesBySearch();
            const activitiesGrid = document.getElementById('activities-grid');
            const emptyState = document.getElementById('activities-empty');
            
            if (filteredActivities.length === 0) {
                activitiesGrid.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            activitiesGrid.classList.remove('hidden');
            
            activitiesGrid.innerHTML = '';
            
            // Sort activities by date (newest first)
            filteredActivities.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            filteredActivities.forEach(activity => {
                const activityCard = createActivityCard(activity);
                activitiesGrid.appendChild(activityCard);
            });
        }

        function createActivityCard(activity) {
            const card = document.createElement('div');
            card.className = 'activity-card bg-white dark:bg-gray-700 rounded-lg p-6 shadow-lg';
            
            const status = getActivityStatus(activity.date);
            const statusClass = getActivityStatusClass(status);
            const statusText = getActivityStatusText(status);
            
            const targetText = getTargetText(activity.target);
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div class="flex-1">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">${activity.name}</h4>
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${statusClass}">${statusText}</span>
                    </div>
                    <div class="flex space-x-1 space-x-reverse">
                        <button onclick="editActivity('${activity.id}')" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 p-2">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteActivity('${activity.id}')" class="text-red-600 hover:text-red-800 dark:text-red-400 p-2">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                
                <p class="text-gray-600 dark:text-gray-400 mb-4 text-sm">${activity.description}</p>
                
                <div class="space-y-2 text-sm">
                    <div class="flex items-center text-gray-600 dark:text-gray-400">
                        <i class="fas fa-calendar ml-2 text-primary"></i>
                        <span>${formatDate(activity.date)}</span>
                    </div>
                    <div class="flex items-center text-gray-600 dark:text-gray-400">
                        <i class="fas fa-clock ml-2 text-primary"></i>
                        <span>${activity.time}</span>
                    </div>
                    ${activity.location ? `
                        <div class="flex items-center text-gray-600 dark:text-gray-400">
                            <i class="fas fa-map-marker-alt ml-2 text-primary"></i>
                            <span>${activity.location}</span>
                        </div>
                    ` : ''}
                    <div class="flex items-center text-gray-600 dark:text-gray-400">
                        <i class="fas fa-users ml-2 text-primary"></i>
                        <span>${targetText}</span>
                    </div>
                </div>
                
                ${activity.notes ? `
                    <div class="mt-4 p-3 bg-gray-50 dark:bg-gray-600 rounded-lg">
                        <p class="text-sm text-gray-600 dark:text-gray-400"><i class="fas fa-sticky-note ml-2"></i>${activity.notes}</p>
                    </div>
                ` : ''}
            `;
            
            return card;
        }

        function getActivityStatus(activityDate) {
            const today = new Date();
            const activity = new Date(activityDate);
            
            today.setHours(0, 0, 0, 0);
            activity.setHours(0, 0, 0, 0);
            
            if (activity < today) return 'completed';
            if (activity.getTime() === today.getTime()) return 'active';
            return 'upcoming';
        }

        function getActivityStatusClass(status) {
            switch (status) {
                case 'completed': return 'activity-status-completed text-white';
                case 'active': return 'activity-status-active text-white';
                case 'upcoming': return 'activity-status-upcoming text-white';
                default: return 'bg-gray-500 text-white';
            }
        }

        function getActivityStatusText(status) {
            switch (status) {
                case 'completed': return 'مكتمل';
                case 'active': return 'جاري اليوم';
                case 'upcoming': return 'قادم';
                default: return 'غير محدد';
            }
        }

        function getTargetText(target) {
            switch (target) {
                case 'all': return 'جميع الصفوف';
                case 'primary': return 'المرحلة الابتدائية';
                case 'middle': return 'المرحلة المتوسطة';
                case 'high': return 'المرحلة الثانوية';
                case 'specific': return 'صفوف محددة';
                default: return target || 'غير محدد';
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-AE', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function searchActivities() {
            const filters = {
                search: document.getElementById('activities-search').value.toLowerCase(),
                date: document.getElementById('activities-date-filter').value,
                status: document.getElementById('activities-status-filter').value
            };
            
            currentActivityFilters = filters;
            displayActivities();
        }

        function clearActivitySearchFilters() {
            document.getElementById('activities-search').value = '';
            document.getElementById('activities-date-filter').value = '';
            document.getElementById('activities-status-filter').value = '';
            
            currentActivityFilters = {};
            displayActivities();
        }

        function filterActivitiesBySearch() {
            let filteredActivities = [...allActivities];
            
            // Filter by search term
            if (currentActivityFilters.search) {
                filteredActivities = filteredActivities.filter(activity => 
                    activity.name.toLowerCase().includes(currentActivityFilters.search) ||
                    activity.description.toLowerCase().includes(currentActivityFilters.search)
                );
            }
            
            // Filter by date
            if (currentActivityFilters.date) {
                filteredActivities = filteredActivities.filter(activity => 
                    activity.date === currentActivityFilters.date
                );
            }
            
            // Filter by status
            if (currentActivityFilters.status) {
                filteredActivities = filteredActivities.filter(activity => {
                    const status = getActivityStatus(activity.date);
                    return status === currentActivityFilters.status;
                });
            }
            
            return filteredActivities;
        }

        async function handleActivitySubmit(e) {
            e.preventDefault();
            
            const form = e.target;
            const editId = form.dataset.editId;
            const isEdit = !!editId;
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const submitText = document.getElementById('activity-submit-text');
            const submitSpinner = document.getElementById('activity-submit-spinner');
            
            // Show loading
            submitText.classList.add('hidden');
            submitSpinner.classList.remove('hidden');
            
            try {
                const activityData = {
                    name: document.getElementById('activity-name').value,
                    description: document.getElementById('activity-description').value,
                    date: document.getElementById('activity-date').value,
                    time: document.getElementById('activity-time').value,
                    location: document.getElementById('activity-location').value || '',
                    target: document.getElementById('activity-target').value,
                    notes: document.getElementById('activity-notes').value || '',
                    createdBy: currentUser.id,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (isEdit) {
                    // Update existing activity
                    await db.collection('activities').doc(editId).update(activityData);
                    showSuccessMessage('تم تحديث النشاط بنجاح');
                } else {
                    // Add new activity
                    activityData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('activities').add(activityData);
                    showSuccessMessage('تمت إضافة النشاط بنجاح');
                }
                
                closeActivityModal();
                document.getElementById('activity-form').reset();
                
            } catch (error) {
                console.error('Error saving activity:', error);
                showErrorMessage('حدث خطأ في ' + (isEdit ? 'تحديث' : 'إضافة') + ' النشاط');
            } finally {
                submitText.classList.remove('hidden');
                submitSpinner.classList.add('hidden');
            }
        }

        async function deleteActivity(activityId) {
            showConfirmDialog('هل أنت متأكد من حذف هذا النشاط؟', async () => {
                try {
                    await db.collection('activities').doc(activityId).delete();
                    showSuccessMessage('تم حذف النشاط بنجاح');
                } catch (error) {
                    console.error('Error deleting activity:', error);
                    showErrorMessage('حدث خطأ في حذف النشاط');
                }
            });
        }

        function editActivity(activityId) {
            const activity = allActivities.find(a => a.id === activityId);
            if (!activity) {
                showErrorMessage('لم يتم العثور على النشاط');
                return;
            }
            
            // Fill the form with existing data
            document.getElementById('activity-name').value = activity.name;
            document.getElementById('activity-description').value = activity.description;
            document.getElementById('activity-date').value = activity.date;
            document.getElementById('activity-time').value = activity.time;
            document.getElementById('activity-location').value = activity.location || '';
            document.getElementById('activity-target').value = activity.target;
            document.getElementById('activity-notes').value = activity.notes || '';
            
            // Change form mode to edit
            document.getElementById('activity-submit-text').textContent = 'حفظ التعديلات';
            document.getElementById('activity-modal-title').textContent = 'تعديل النشاط';
            
            // Store activity ID for updating
            document.getElementById('activity-form').dataset.editId = activityId;
            
            openActivityModal();
        }

        function displayUsers() {
            const tableBody = document.getElementById('users-table-body');
            const tableContainer = document.getElementById('users-table-container');
            const emptyState = document.getElementById('users-empty');
            
            if (allUsers.length === 0) {
                tableContainer.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            tableContainer.classList.remove('hidden');
            
            tableBody.innerHTML = '';
            allUsers.forEach(user => {
                const permissions = Array.isArray(user.permissions) ? 
                    user.permissions.map(p => getGradeName(p)).join(', ') : 'غير محدد';
                    
                const sectionPermissions = Array.isArray(user.sectionPermissions) ? 
                    user.sectionPermissions.join(', ') : 'غير محدد';
                
                const row = tableBody.insertRow();
                row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors';
                row.innerHTML = `
                    <td class="border border-gray-300 dark:border-gray-600 px-4 py-2">${user.name}</td>
                    <td class="border border-gray-300 dark:border-gray-600 px-4 py-2">${user.username}</td>
                    <td class="border border-gray-300 dark:border-gray-600 px-4 py-2">
                        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs">${user.role === 'teacher' ? 'معلم' : 'مدير'}</span>
                    </td>
                    <td class="border border-gray-300 dark:border-gray-600 px-4 py-2">
                        <div class="text-xs">
                            <div><strong>الصفوف:</strong> ${permissions}</div>
                            <div><strong>الشعب:</strong> ${sectionPermissions}</div>
                        </div>
                    </td>
                    <td class="border border-gray-300 dark:border-gray-600 px-4 py-2">
                        <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">${user.status === 'active' ? 'نشط' : 'معلق'}</span>
                    </td>
                    <td class="border border-gray-300 dark:border-gray-600 px-4 py-2">
                        <button onclick="editUser('${user.id}')" class="text-blue-600 hover:text-blue-800 ml-2">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteUser('${user.id}')" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
        }

        function editUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) {
                showErrorMessage('لم يتم العثور على المستخدم');
                return;
            }
            
            // Fill the form with existing data
            document.getElementById('modal-user-name').value = user.name;
            document.getElementById('modal-user-username').value = user.username;
            document.getElementById('modal-user-password').value = ''; // Don't show password for security
            document.getElementById('modal-user-role').value = user.role;
            
            // Set grade permissions
            document.querySelectorAll('.user-permissions').forEach(checkbox => {
                checkbox.checked = user.permissions && user.permissions.includes(checkbox.value);
            });
            
            // Set section permissions
            document.querySelectorAll('.section-permissions').forEach(checkbox => {
                checkbox.checked = user.sectionPermissions && user.sectionPermissions.includes(checkbox.value);
            });
            
            // Change form mode to edit
            document.getElementById('user-submit-text').textContent = 'حفظ التعديلات';
            document.getElementById('user-modal-title').textContent = 'تعديل المستخدم';
            document.getElementById('modal-user-password').placeholder = 'اتركها فارغة للاحتفاظ بكلمة المرور الحالية';
            document.getElementById('modal-user-password').required = false;
            
            // Store user ID for updating
            document.getElementById('user-form').dataset.editId = userId;
            
            openUserModal();
        }

        async function deleteUser(userId) {
            showConfirmDialog('هل أنت متأكد من حذف هذا المستخدم؟', async () => {
                try {
                    await db.collection('users').doc(userId).delete();
                    showSuccessMessage('تم حذف المستخدم بنجاح');
                } catch (error) {
                    console.error('Error deleting user:', error);
                    showErrorMessage('حدث خطأ في حذف المستخدم');
                }
            });
        }

        async function deleteStudent(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            if (student && !hasPermissionForGradeAndSection(student.grade, student.section)) {
                showErrorMessage('ليس لديك صلاحية لحذف هذا الطالب');
                return;
            }
            
            showConfirmDialog('هل أنت متأكد من حذف هذا الطالب؟', async () => {
                try {
                    await db.collection('students').doc(studentId).delete();
                    showSuccessMessage('تم حذف الطالب بنجاح');
                } catch (error) {
                    console.error('Error deleting student:', error);
                    showErrorMessage('حدث خطأ في حذف الطالب');
                }
            });
        }

        function editStudent(studentId) {
            showInfoMessage('سيتم تطوير ميزة التعديل قريباً');
        }

        function sendWhatsAppToParent(phoneNumber, studentName) {
            const message = encodeURIComponent(`مرحباً، هذه رسالة من مدرسة الثروات الوطنية الخاصة بخصوص الطالب ${studentName}.`);
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${message}`;
            window.open(whatsappUrl, '_blank');
        }

        function getGradeName(gradeId) {
            const gradeNames = {
                'grade1': 'الأول', 'grade2': 'الثاني', 'grade3': 'الثالث', 'grade4': 'الرابع',
                'grade5': 'الخامس', 'grade6': 'السادس', 'grade7': 'السابع', 'grade8': 'الثامن',
                'grade9': 'التاسع', 'grade10': 'العاشر', 'grade11': 'الحادي عشر', 'grade12': 'الثاني عشر'
            };
            return gradeNames[gradeId] || gradeId;
        }

        function getGradeBadge(gradeId) {
            const gradeNames = {
                'grade1': 'الأول', 'grade2': 'الثاني', 'grade3': 'الثالث', 'grade4': 'الرابع',
                'grade5': 'الخامس', 'grade6': 'السادس', 'grade7': 'السابع', 'grade8': 'الثامن',
                'grade9': 'التاسع', 'grade10': 'العاشر', 'grade11': 'الحادي عشر', 'grade12': 'الثاني عشر'
            };
            const gradeName = gradeNames[gradeId] || gradeId;
            return `<span class="bg-primary text-white px-2 py-1 rounded-full text-xs">${gradeName}</span>`;
        }

        // Modal functions
        function openPlanModal() {
            if (!document.getElementById('plan-form').dataset.editId) {
                document.getElementById('plan-submit-text').textContent = 'حفظ الخطة';
                document.getElementById('plan-modal-title').textContent = 'إضافة خطة أسبوعية';
            }
            
            document.getElementById('add-plan-modal').classList.remove('hidden');
            document.getElementById('add-plan-modal').classList.add('flex');
        }

        function closePlanModal() {
            document.getElementById('add-plan-modal').classList.add('hidden');
            document.getElementById('add-plan-modal').classList.remove('flex');
            document.getElementById('plan-form').reset();
            delete document.getElementById('plan-form').dataset.editId;
            
            document.getElementById('plan-submit-text').textContent = 'حفظ الخطة';
            document.getElementById('plan-modal-title').textContent = 'إضافة خطة أسبوعية';
        }

        function openStudentModal() {
            document.getElementById('add-student-modal').classList.remove('hidden');
            document.getElementById('add-student-modal').classList.add('flex');
        }

        function closeStudentModal() {
            document.getElementById('add-student-modal').classList.add('hidden');
            document.getElementById('add-student-modal').classList.remove('flex');
            document.getElementById('student-form').reset();
        }

        function openReportModal() {
            document.getElementById('add-report-modal').classList.remove('hidden');
            document.getElementById('add-report-modal').classList.add('flex');
        }

        function closeReportModal() {
            document.getElementById('add-report-modal').classList.add('hidden');
            document.getElementById('add-report-modal').classList.remove('flex');
            document.getElementById('report-form').reset();
        }

        function openActivityModal() {
            if (!document.getElementById('activity-form').dataset.editId) {
                document.getElementById('activity-submit-text').textContent = 'إضافة النشاط';
                document.getElementById('activity-modal-title').textContent = 'إضافة نشاط جديد';
            }
            
            document.getElementById('add-activity-modal').classList.remove('hidden');
            document.getElementById('add-activity-modal').classList.add('flex');
        }

        function closeActivityModal() {
            document.getElementById('add-activity-modal').classList.add('hidden');
            document.getElementById('add-activity-modal').classList.remove('flex');
            document.getElementById('activity-form').reset();
            delete document.getElementById('activity-form').dataset.editId;
            
            document.getElementById('activity-submit-text').textContent = 'إضافة النشاط';
            document.getElementById('activity-modal-title').textContent = 'إضافة نشاط جديد';
        }

        function openUserModal() {
            if (currentUser && currentUser.role !== 'admin') {
                showErrorMessage('ليس لديك صلاحية لإدارة المستخدمين');
                return;
            }
            
            if (!document.getElementById('user-form').dataset.editId) {
                document.getElementById('user-submit-text').textContent = 'إضافة المستخدم';
                document.getElementById('user-modal-title').textContent = 'إضافة مستخدم جديد';
                document.getElementById('modal-user-password').placeholder = 'كلمة المرور';
                document.getElementById('modal-user-password').required = true;
            }
            
            document.getElementById('add-user-modal').classList.remove('hidden');
            document.getElementById('add-user-modal').classList.add('flex');
        }

        function closeUserModal() {
            document.getElementById('add-user-modal').classList.add('hidden');
            document.getElementById('add-user-modal').classList.remove('flex');
            document.getElementById('user-form').reset();
            delete document.getElementById('user-form').dataset.editId;
            document.querySelectorAll('.user-permissions').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.querySelectorAll('.section-permissions').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            document.getElementById('user-submit-text').textContent = 'إضافة المستخدم';
            document.getElementById('user-modal-title').textContent = 'إضافة مستخدم جديد';
            document.getElementById('modal-user-password').placeholder = 'كلمة المرور';
            document.getElementById('modal-user-password').required = true;
        }

        // Statistics updates
        function updatePlansCount() {
            document.getElementById('plans-count').textContent = allPlans.length;
        }

        function updateTeachersCount() {
            document.getElementById('teachers-count').textContent = allUsers.length;
        }

        function updateStudentsCount() {
            document.getElementById('students-count').textContent = allStudents.length;
        }

        function updateActivitiesCount() {
            document.getElementById('activities-count').textContent = allActivities.length;
        }

        function updateReportsCount() {
            document.getElementById('reports-count').textContent = allReports.length;
        }

        // Utility functions
        function hideLoading(section) {
            const loadingElement = document.getElementById(`${section}-loading`);
            if (loadingElement) {
                loadingElement.classList.add('hidden');
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function highlightSearchTerm(text, searchTerm) {
            if (!searchTerm) return text;
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }

        function showSuccessMessage(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 success-message text-white px-6 py-3 rounded-lg shadow-lg z-50 slide-in-right';
            alertDiv.innerHTML = `
                <div class="flex items-center space-x-2 space-x-reverse">
                    <i class="fas fa-check-circle"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        function showErrorMessage(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 error-message text-white px-6 py-3 rounded-lg shadow-lg z-50 slide-in-right';
            alertDiv.innerHTML = `
                <div class="flex items-center space-x-2 space-x-reverse">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        function showInfoMessage(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 slide-in-right';
            alertDiv.innerHTML = `
                <div class="flex items-center space-x-2 space-x-reverse">
                    <i class="fas fa-info-circle"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        function showConfirmDialog(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end space-x-3 space-x-reverse">
                        <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">إلغاء</button>
                        <button class="confirm-btn px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded">تأكيد</button>
                    </div>
                </div>
            `;
            
            modal.querySelector('.cancel-btn').addEventListener('click', () => {
                modal.remove();
            });
            
            modal.querySelector('.confirm-btn').addEventListener('click', () => {
                modal.remove();
                onConfirm();
            });
            
            document.body.appendChild(modal);
        }

        // Global functions for button clicks
        window.editPlan = editPlan;
        window.deletePlan = deletePlan;
        window.archivePlan = archivePlan;
        window.unarchivePlan = unarchivePlan;
        window.editStudent = editStudent;
        window.deleteStudent = deleteStudent;
        window.editActivity = editActivity;
        window.deleteActivity = deleteActivity;
        window.editUser = editUser;
        window.deleteUser = deleteUser;
        window.sendWhatsAppToParent = sendWhatsAppToParent;
        window.sendStudentReportViaWhatsApp = sendStudentReportViaWhatsApp;
        window.switchTab = switchTab;

        // Enhanced plan functions with sections
        function editPlan(planId) {
            const plan = allPlans.find(p => p.id === planId);
            if (!plan) {
                showErrorMessage('لم يتم العثور على الخطة');
                return;
            }
            
            if (plan.teacherId !== currentUser.id && currentUser.role !== 'admin') {
                showErrorMessage('ليس لديك صلاحية لتعديل هذه الخطة');
                return;
            }
            
            // Fill the form with existing data
            document.getElementById('plan-grade').value = plan.grade;
            document.getElementById('plan-section').value = plan.section;
            document.getElementById('plan-date').value = plan.planDate || '';
            document.getElementById('plan-day').value = plan.day;
            document.getElementById('plan-subject').value = plan.subject;
            document.getElementById('plan-topic').value = plan.topic;
            document.getElementById('plan-activities').value = plan.activities;
            
            // Change form mode to edit
            document.getElementById('plan-submit-text').textContent = 'حفظ التعديلات';
            document.getElementById('plan-modal-title').textContent = 'تعديل الخطة الأسبوعية';
            
            // Store plan ID for updating
            document.getElementById('plan-form').dataset.editId = planId;
            
            openPlanModal();
        }

        async function archivePlan(planId) {
            const plan = allPlans.find(p => p.id === planId);
            if (plan && plan.teacherId !== currentUser.id && currentUser.role !== 'admin') {
                showErrorMessage('ليس لديك صلاحية لأرشفة هذه الخطة');
                return;
            }
            
            try {
                await db.collection('weeklyPlans').doc(planId).update({
                    archived: true,
                    archivedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showSuccessMessage('تم أرشفة الخطة بنجاح');
            } catch (error) {
                console.error('Error archiving plan:', error);
                showErrorMessage('حدث خطأ في أرشفة الخطة');
            }
        }

        async function unarchivePlan(planId) {
            const plan = allPlans.find(p => p.id === planId);
            if (plan && plan.teacherId !== currentUser.id && currentUser.role !== 'admin') {
                showErrorMessage('ليس لديك صلاحية لإلغاء أرشفة هذه الخطة');
                return;
            }
            
            try {
                await db.collection('weeklyPlans').doc(planId).update({
                    archived: false,
                    unarchivedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showSuccessMessage('تم إلغاء أرشفة الخطة بنجاح');
            } catch (error) {
                console.error('Error unarchiving plan:', error);
                showErrorMessage('حدث خطأ في إلغاء أرشفة الخطة');
            }
        }

        async function deletePlan(planId) {
            const plan = allPlans.find(p => p.id === planId);
            if (plan && plan.teacherId !== currentUser.id && currentUser.role !== 'admin') {
                showErrorMessage('ليس لديك صلاحية لحذف هذه الخطة');
                return;
            }
            
            showConfirmDialog('هل أنت متأكد من حذف هذه الخطة؟', async () => {
                try {
                    await db.collection('weeklyPlans').doc(planId).delete();
                    showSuccessMessage('تم حذف الخطة بنجاح');
                } catch (error) {
                    console.error('Error deleting plan:', error);
                    showErrorMessage('حدث خطأ في حذف الخطة');
                }
            });
        }
    </script>
</body>
</html>
